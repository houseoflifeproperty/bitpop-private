define("main",["require","ext.require.config"],function(b,d){global_require.config(d);return{init:function(){b("underscore notifications search surf_link settings sandbox_helpers app_helpers bench config app.torque".split(" "),function(){var c=b("underscore"),a=b("sandbox_helpers");b("bench");var e=b("config"),g=b("settings"),d=b("notifications"),h=b("search"),k=b("surf_link"),l=b("app.torque"),j,m,n,p,r,q,s;e.data_path=_config.data_path;n=_sandbox.observer.load("parser");j=_sandbox.observer.load("sites");
p=_sandbox.observer.load("popup");r=_sandbox.observer.load("app");m=_sandbox.observer.load("search");q=_sandbox.observer.load("clipboard");s=_sandbox.storage.load("settings",{wait:300,defaults:e.app.settings_defaults}).on("reset",function(){var a=!!s.get("remember_association");a||d.push({type:"association",name:"Remember",action:"Association Settings",id:"association",img:e.data_path+"app/img/icon_search_add.png",priority:90,data:{name:a.toString()}})});p.on("reset",function(){c.each(_sandbox.storage.get(),
function(a){c.contains(["sources","bench"],a.KEY)||a.clear()})});j.on("enabled",function(b){var c=b.url.getBasePath();d.push({type:e.app.notifications.SEARCH_SITE_ADDED,name:"Search site",action:"enabled",id:c,img:e.data_path+"app/img/icon_search_add.png",data:{url:c,favicon:b.favicon}});a.track("sites","add",null,null)});j.on("disabled",function(b){var c=b.url.getBasePath();d.push({type:e.app.notifications.SEARCH_SITE_DECLINED,name:"Search site",action:"disabled",id:c,img:e.data_path+"app/img/icon_minus_w.png",
data:{url:c,favicon:b.favicon}});a.track("sites","detected",null,null)});j.on("detected",function(b){var c=b.url.getBasePath();d.push({type:e.app.notifications.SEARCH_SITE_DISCOVERED,name:"Search site",action:"discovered",id:c,img:e.data_path+"app/img/icon_search_add.png",data:{url:c,favicon:b.favicon}});a.track("sites","detected",null,null)});n.on("add_fail",function(b){b=b.key;d.push({type:e.app.notifications.SEARCH_SITE_ADD_FAIL,name:"Search site",action:"rejected",id:b,img:e.data_path+"app/img/icon_notification_alert.png",
data:{url:b}});a.track("sites","add_fail",null,null)});n.on("attempt_add",function(b){d.push({type:e.app.notifications.ATTEMPT_ADD_SITE,name:"Verifying",action:"search site",id:b,img:e.data_path+"app/img/add-site_spinner.png",data:{url:b}});a.track("sites","attempt_add",null,null)});j.on("defaults",function(a){var b=[];c.each(a,function(a){b.push(a.data.url.getBasePath())});d.set_default_engines(b)});r.on("torrent:added",function(b,c){a.getTimestamp();var g={type:e.app.notifications.DOWNLOAD_STARTED,
name:"Download",action:"started",id:b.id,img:e.data_path+"app/img/icon_plus_w.png",timestamp:b.properties.completed_on,data:{id:b.id,name:b.properties.name}};b.properties.completed_on&&(c=!0,g.action="completed",g.type=e.app.notifications.DOWNLOAD_COMPLETE,g.img=e.data_path+"app/img/icon_check_w.png",g.priority=30,g.alert_seen=!0,g.resolved=!0,g.seen=!0);c||(g.priority=70);d.push(g)});r.on("torrent:removed",function(a){d.remove(a.id)});r.on("torrent:completed",function(a){d.remove(a.id,{silent:!0});
setTimeout(function(){d.push({type:e.app.notifications.DOWNLOAD_COMPLETE,name:"Download",action:"completed",id:a.id,img:e.data_path+"app/img/icon_check_w.png",data:{id:a.id,name:a.properties.name}})},250)});m.on("search_start",function(a){d.remove(a,{silent:!0});d.push({type:e.app.notifications.SEARCH_START,name:"Search",action:"initiated",id:a,img:e.data_path+"app/img/icon_search.png",data:{id:a,name:a}})});m.on("complete",function(a,b){var c="Search",g,h;switch(b){case "scrape":c="Fetching";g="torrent health";
h=e.app.notifications.SEARCH_COMPLETE;break;case !1:g="completed",h=e.app.notifications.SCRAPE_COMPLETE}d.remove(a,{silent:!0});d.push({type:h,name:c,action:g,id:a,img:e.data_path+"app/img/icon_search.png",data:{id:a,name:a}})});q.on("copied",function(a){d.push({type:e.app.notifications.CLIP,name:"Link",action:"copied",img:e.data_path+"app/img/icon_check_w.png",data:{name:a}})});g=g.init();d.init();h.init();k.init();$(document).ready(function(){l=l.init();window.torque_app=l});window._search=h})}}});
define("app/ext",function(){});(function(){define("app_helpers",["require"],function(){var b={"isohunt.com":/\/\/(.*\.)?isohunt.com.([a-z]){1,3}/i,google:/\/\/(.*\.)?google.([a-z]){1,3}/i,bing:/\/\/(.*\.)?bing.([a-z]){1,3}/i,yahoo:/\/\/(.*\.)?yahoo.([a-z]){1,3}/i,archive:/\/\/(.*\.)?archive.([a-z]){1,3}/i};return{check_is_special:function(d){var c=!1,a;for(a in b)if(b[a].test(d)){c=a;break}return c}}})})();
(function(){define("parser_cache",["require","underscore","sandbox_helpers","app_helpers","jquery"],function(){var b={},d=require("sandbox_helpers"),c=require("app_helpers"),a=null,e={monitor_time:25E3,expiration_time:2592E3,pattern_update_time:36E5,pattern_expiration_time:2592E3,engine_blacklists:{"isohunt.com":"",google:"webcache.googleusercontent.com@url?q=",bing:"",yahoo:"search.yahoo.com@**"},update_url:"https://s3.amazonaws.com/btsurf/parser_update.json"},g=!1,i=null,h={l1:{},l2:{},l3:{},tr:{y:[],n:[],q:[]},
en:!1},k=function(){var b=a.get();h=b;b.en&&b.en.dict&&(e.engine_blacklists=b.en.dict);j()},l=function(){clearTimeout(i);g&&(a.set(h).save(),g=!1);i=setTimeout(function(){l()},e.monitor_time)},j=function(){clearTimeout(null);var a=d.getTimestamp();(!h.en||a-h.en.ts>=e.pattern_expiration_time)&&_sandbox.request.request({url:e.update_url,beforeSend:"emptyAjaxHeader",dataType:"html"}).then(function(a){try{var b=JSON.parse(a.data);e.engine_blacklists=b;h.en={ts:d.getTimestamp(),dict:b};g=!0}catch(c){}},
function(){});setTimeout(function(){j()},e.pattern_update_time)};_.extend(b,{init:function(b){_.extend(e,b);a=_sandbox.storage.load("pattern_cache",{wait:500,defaults:h});a.on("reset",k);l()},get:function(a,b){if(!a&&!b)return h;if(a&&!b)return h[a];if(a&&b)return h[a][b]},prepare:function(a,b,g){if(h[a][b]){var i=d.getTimestamp(),j=c.check_is_special(g);(i-h[a][b].ts>e.expiration_time||j&&h.en&&h[a][b].ts<h.en.ts)&&delete h[a][b]}if(!h[a][b]){i={ts:d.getTimestamp(),p:{},w:!1,d:!1};if(g=c.check_is_special(g)){var g=
e.engine_blacklists[g].split("@"),k;0<g.length&&(k=g[1]);g=g[0].split(",");j=g.length;k&&(i.d=k);if(j)for(k=0;k<j;k++)g[k]&&(i.p[g[k]]=!0)}h[a][b]=i}},whitelist:function(a,b,c){h[a][b].w!==c&&(h[a][b].w=c,g=!0)},blacklist:function(a,b,c){c&&!h[a][b].p[c]&&(h[a][b].p[c]=1,g=!0)},is_whitelisted:function(a,b,c){a=h[a][b];return!a?!1:a.w&&a.w===c},is_blacklisted:function(a,b,c){a=h[a][b];return!a?!1:a.p&&a.p[c]}});return b})})();
define("request_queue",["require","underscore"],function(){var b=null,d=function(a){this.options={size:4};_.extend(this.options,a);this.in_use=0};d.prototype={take:function(){return this.in_use<this.options.size?(this.in_use++,!0):!1},release:function(){0<this.in_use&&this.in_use--}};var c=function(a){this.request_func=!a.func?b.request:a.func;this.queue=[];this.running=!1;this.timeout=null;this.aborted=!1;this.options=_.extend({spacing:100,max_concurrent_requests:4},a);this.requests={};this.pool=
new d({size:this.options.max_concurrent_requests})};c.prototype={push:function(a){var b=new $.Deferred;this.aborted?b.reject(null,"abort","abort"):(this.queue.push({opts:a,dfd:b}),this.start());return b.promise()},dequeue:function(){clearTimeout(this.timeout);this.queue.length?(this.pool.take()&&this.request(),this.timeout=setTimeout(this.dequeue.bind(this),this.options.spacing)):this.running=!1},request:function(){var a=this.queue.shift(),b=a.opts,c=a.dfd,a=this.request_func(b);a.then(_.bind(function(a){c.resolve.apply(c,
arguments);delete this.requests[b.url];this.pool.release()},this),_.bind(function(a){c.reject.apply(c,arguments);delete this.requests[b.url];this.pool.release()},this));this.requests[b.url]=a},start:function(){this.running||(this.running=!0,this.dequeue())},abort:function(){clearTimeout(this.timeout);for(this.aborted=!0;this.queue.length;)this.queue.pop().dfd.reject(null,"error","abort");setTimeout(_.bind(function(){for(var a in this.requests)this.requests[a].abort()},this),0);this.running=!1}};return{init:function(){b=
_sandbox.request},RequestQueue:c}});
function sha1Hash(b){for(var d=[1518500249,1859775393,2400959708,3395469782],b=b+String.fromCharCode(128),c=Math.ceil((b.length/4+2)/16),a=Array(c),e=0;e<c;e++){a[e]=Array(16);for(var g=0;16>g;g++)a[e][g]=b.charCodeAt(64*e+4*g)<<24|b.charCodeAt(64*e+4*g+1)<<16|b.charCodeAt(64*e+4*g+2)<<8|b.charCodeAt(64*e+4*g+3)}a[c-1][14]=8*(b.length-1)/Math.pow(2,32);a[c-1][14]=Math.floor(a[c-1][14]);a[c-1][15]=8*(b.length-1)&4294967295;for(var b=1732584193,g=4023233417,i=2562383102,h=271733878,k=3285377520,l=Array(80),
j,m,n,p,r,e=0;e<c;e++){for(var q=0;16>q;q++)l[q]=a[e][q];for(q=16;80>q;q++)l[q]=ROTL(l[q-3]^l[q-8]^l[q-14]^l[q-16],1);j=b;m=g;n=i;p=h;r=k;for(q=0;80>q;q++){var s=Math.floor(q/20),s=ROTL(j,5)+f(s,m,n,p)+r+d[s]+l[q]&4294967295;r=p;p=n;n=ROTL(m,30);m=j;j=s}b=b+j&4294967295;g=g+m&4294967295;i=i+n&4294967295;h=h+p&4294967295;k=k+r&4294967295}return b.toHexStr()+g.toHexStr()+i.toHexStr()+h.toHexStr()+k.toHexStr()}
function f(b,d,c,a){switch(b){case 0:return d&c^~d&a;case 1:return d^c^a;case 2:return d&c^d&a^c&a;case 3:return d^c^a}}function ROTL(b,d){return b<<d|b>>>32-d}Number.prototype.toHexStr=function(){for(var b="",d,c=7;0<=c;c--)d=this>>>4*c&15,b+=d.toString(16);return b};define("sha1",function(){});
(function(){define("parser","require underscore sandbox_helpers app_helpers jquery config parser_cache request_queue sha1 q".split(" "),function(){var b={},d=require("q");require("sha1");var c=null,a=null,e=require("config"),g=require("parser_cache"),i=require("sandbox_helpers"),h=require("app_helpers"),k=require("request_queue"),l=/<[^>]*>?/ig,j=/[^\W\d\_]+|[^\u0000-\u0080]+/,m=!1,n=function(b){c.request({url:"http://www.google.com/search?q="+b.query,dataType:"html"}).then(function(c){if((c=/<a[^>]+class="?spell"?[^>]*>(<[^<>]+>)*(.+?)(<\/[^<>]+>)*<\/a>/mi.exec(c.data))&&
"undefined"!==typeof c[2])c=c[2].replace(l,""),a.trigger("spell",c,b.query)},function(){})},p=function(c){if(c.manual)return r.apply(this,arguments);b.check_search(c).done(function(b){a.trigger("detected",{search:b,key:c.key})}).fail(function(){a.trigger("rejected",{key:c.key,silent:!0})})},r=function(c){var e=c.url.getBasePath(),g=c.url.getBaseUrl(),d=function(b){a.trigger("detected",{search:b,key:e,silent:!0});a.trigger("added",{key:e,track:!0})},i=function(){a.trigger("add_fail",{key:e,silent:!1})};
a.trigger("attempt_add",e);A(c.url).fail(i).done(function(a){b.check_search({favicon:null,html:a,key:e,url:g}).then(d,i)})},q=function(a,b,d){var i=new $.Deferred;if(!a)return d?(i.reject(),i.promise()):null;var m=h.check_is_special(a.url.getBaseUrl()),l="archive"===m,n=0<=a.url.indexOf(e.app.btfc_url[e.env]),q=m?2:1,u={};a.url.getBaseUrl();if(m&&d)return i.reject(a),i.promise();a.param&&(u[a.param]=b+(l?' AND format:"Archive BitTorrent"':m?" torrent":""));u={url:a.url,data:_.extend(u,a.hidden_els),
beforeSend:"emptyAjaxHeader",dataType:"html",timeout:25E3};c.request(u).then(function(e){var u={site:a,query:b,data:e.data,is_test:d,pattern_length:q,is_special:m};if(l){var e=new $.Deferred,p=JSON.parse(u.data),r=0;if(p&&p.response&&p.response.docs)for(var y=0,A=p.response.docs.length;y<A;y++){var v="http://archive.org/details/"+p.response.docs[y].identifier;_.extend(u,{url:v,link:{href:v,text:p.response.docs[y].title},downloads:{torrents:["http://archive.org/download/"+p.response.docs[y].identifier+
"/"+p.response.docs[y].identifier+"_archive.torrent"],magnets:[]},is_archive:!0});C(u);r++;if(10<=r)break}e.resolve(u);e=e.promise()}else if(n){var e=new $.Deferred,p=JSON.parse(u.data),G=0,r=function(a){for(var b=0,c=a.length;b<c;b++)if(s(u,a[b]),G++,console.log("anlyze btfc loop",G,10),10<=G){console.error("BREAK:  anlyze btfc loop",G,10);break}};if(p&&p.recommendations&&0<p.recommendations.length)if(1==p.recommended_genres.length&&u.query===p.recommended_genres[0])r(p.recommendations);else{y=[];
A=u.query;if(2<A.length)for(var A=A.trim().toLowerCase(),v=0,H=p.recommendations.length;v<H;v++)0<=p.recommendations[v].title.toLowerCase().indexOf(A)&&y.push(p.recommendations[v]);if(0<y.length)r(y);else{u.recommended_genres=p.recommended_genres;v=0;for(H=p.recommendations.length;v<H;v++)u.order=v,s(u,p.recommendations[v],!0)}}e.resolve(u);e=e.promise()}else{var I=new $.Deferred,K=[],J=u.site.url.getBaseUrl(),E=u.site.url.getBasePath();g.prepare("l1",E,J);e=t(u.data);if(e.length){p={};r=0;for(y=
e.length;r<y;r++)if(0!==e[r].href.indexOf("irc://")&&(A=D(e[r].href,J),!(4>e[r].text.length)&&j.test(e[r].text)&&(!p[A]||p[A].text.length<e[r].text.length)))p[A]=e[r];var L=new k({func:c.request,spacing:u.is_special?200:100,max_concurrent_requests:u.is_special?5:10}),M=0;_.each(p,function(a,b){var c=g.get("l1",E);if(c.d){var e=a.href,d=!1;_.each(e.split(c.d),function(a){if(-1<a.indexOf("http"))return d=decodeURIComponent(a).split("&amp;")[0],!1});a.href=d||e;b=D(a.href,J)}c=w(a.href);c=z(c,E);if(!u.is_special||
!h.check_is_special(b.getBaseUrl()))if(e=c.join("/"),c.length&&!(-1!==a.href.indexOf("#")||"search"===c[0]||"cached"===a.text.toLowerCase())){var i=B(c,u.pattern_length);if(g.is_whitelisted("l1",E,i)||!g.is_blacklisted("l1",E,i)&&-1===e.indexOf(".torrent")&&-1===e.indexOf("magnet:?"))c=x({url:b,link:a,structure:c,path:E,is_test:u.is_test,query:u.query,queue:L,site:u.site,pattern_length:u.pattern_length,pattern:i}),c.done(function(a){a.downloads&&(M++,10<=M&&L.abort())}),K.push(c)}});$.when.apply($,
K).then(function(){for(var a=Array.prototype.slice.call(arguments,0),b=!1,c=0,e=a.length;c<e;c++)if(a[c].downloads){b=!0;break}I.resolve(b)},function(){});e=I.promise()}else I.reject(),e=void 0}e.done(function(b){b&&d?i.resolve(a):d?i.reject(a):i.resolve(a)}).fail(function(a){i.reject(a.site)})},function(){a.cache_lookup_succeeded&&(a.cache_lookup_succeeded=!1);i.reject(a)});return i.promise()},s=function(a,b,c){if(b&&void 0!==b){var e=b.href,g=c||!1;_.extend(a,{url:e,link:{href:e,text:b.title},downloads:{torrents:[b.torrent],
magnets:[]}})}_.extend(a,{is_btfc_recommendation:g,is_btfc_result:!g});C(a)},x=function(a){var b=new $.Deferred;a.queue.push({url:a.url,beforeSend:"emptyAjaxHeader",dataType:"html",timeout:25E3}).then(function(c){for(var e=_.extend(a,{html:c.data}),d=new $.Deferred,c=e.path,i=e.url.getBaseUrl(),h=t(e.html),j={magnets:[],torrents:[]},m=0,l=h.length;m<l;m++){var n=h[m].href,u=n.split("?")[0];0===n.indexOf("magnet:?")&&!_.contains(j.magnets,n)?j.magnets.push(h[m].href):-1!==n.indexOf(".torrent")&&((".torrent"===
n.substring(n.length,n.length-8)||".torrent"===u.substring(u.length,u.length-8))&&!_.contains(j.torrents,n))&&j.torrents.push(n)}var p;if(0===j.magnets.length&&0===j.torrents.length)d.reject(j);else if(0===j.torrents.length&&9>=j.magnets.length)d.resolve(j);else if(j.torrents.length&&9>=j.torrents.length){var r=[],q=[],s=new k({});g.prepare("l2",c,i);j.torrents.forEach(function(a,b){if(0<b)return!1;var c=e.queue,d=_.clone(e);d.header_queue=s;d.queue=c;var i=new $.Deferred,h=d.path,j=D(a,d.url.getBaseUrl()),
c=w(j),c=z(c,h),m=B(c,d.pattern_length);if(g.is_whitelisted("l2",h,m)||!g.is_blacklisted("l2",h,m)){var k=new $.Deferred;d.header_queue.push({url:j,timeout:25E3,dataType:"head",before_send:"emptyAjaxHeader"}).done(function(a){k.resolve(a)}).fail(function(){k.resolve(!1)});k.promise().done(function(a){var c=a.data;if(c)if(a=c["content-disposition"],c=c["content-type"],"text/html"===c&&!d.deep_check){var e=new $.Deferred,a=w(j),c=d.path,a=z(a,c),k=B(a,d.pattern_length);(g.is_whitelisted("l2",c,k)||
!g.is_blacklisted("l2",c,k))&&1<a.length?(d.url=j,d.structure=a,d.is_test=!0,d.pattern=k,x(d).done(function(a){a.downloads&&a.downloads.torrents.length?e.resolve(a.downloads.torrents):e.reject()})):e.reject();e.promise().done(function(a){i.resolve(a)}).fail(function(){i.resolve([])})}else"application/x-bittorrent"!==c&&"application/octet-stream"!==c&&(!a||-1===a.indexOf(".torrent"))?(g.blacklist("l2",h,m),i.resolve([])):(g.whitelist("l2",h,m),i.resolve([j]));else a=function(a){g.whitelist("l2",h,
m);i.resolve([j],a)},c=function(){g.blacklist("l2",h,m);i.resolve([])},0===b?y(j,d.header_queue).then(a,c):c()})}else i.resolve([]);c=i.promise();c.done(function(a,b){q=q.concat(a);b&&(p=b)});r.push(c)});$.when.apply($,r).then(function(){j.torrents=q;9<j.torrents.length||9<j.magnets.length?d.reject(j):j.torrents.length||j.magnets.length?d.resolve(j,p):d.reject(j)},function(){})}else d.reject(j);d.promise().done(function(c,e){g.whitelist("l1",a.path,a.pattern);_.extend(a,{downloads:c});b.resolve(a);
!a.is_test&&!a.queue.aborted&&C(a,e)}).fail(function(){g.blacklist("l1",a.path,a.pattern);b.resolve(a)})},function(){b.resolve(a)});return b.promise()},t=function(a){for(var b=["title","href","TITLE","HREF"],c=["a","A"],e=[],g=0,d=c.length;g<d;g++)for(var h=0,j=a.split("<"+c[g]),m=j.length;h<m;h++){var k=j[h];if(-1!==k.indexOf("</"+c[g]+">")){var n=k.split("</"+c[g]+">")[0],u={},n=n.split(">");n.shift();u.text=i.html_entity_decode(n.join(">").replace(l,"")).trim();for(var n=0,p=b.length;n<p;n++){var z=
b[n],r=k.split(z+"=");2>r.length||(u[z.toLowerCase()]=r[1].split(" ")[0].strip('"').strip("'").split('"')[0].split("'")[0].split(">")[0].strip('"').strip("'").split('"')[0].split("'")[0])}u.href&&(u.href.indexOf(">"),e.push(u))}}return e},w=function(a){for(a=a.strip("/").split("/");a.length&&(0===a[0].indexOf("http")||""===a[0]);)a.shift();return a},z=function(a,b){for(var c=!1;!c;)a.length&&(a[0]===b||""===a[0]||-1<a[0].indexOf(b))?a.shift():c=!0;return a},B=function(a,b){for(var c=[],e=0;e<b;e++)c.push(a[e]);
c=c.join("_");0<c.indexOf("?")&&(c=c.split("?")[0]);return c},A=function(a){var b=new $.Deferred;c.request({url:a.getBaseUrl(),dataType:"html"}).then(function(a){b.resolve(a.data)},function(){b.reject()});return b.promise()},v=function(a){for(var b=a.url.getBaseUrl(),c="",e=0,a=a.html.split("<link"),g=a.length;e<g;e++){var d=a[e];if(!(-1===d.indexOf("rel=")||-1===d.indexOf("href=")))if(d="<link"+d.split(">")[0]+">",-1!==d.indexOf("icon")){c=d.split("href=")[1].split(" ")[0].strip('"').strip("'").split('"')[0].split("'")[0];
c=D(c,b);break}}return c},D=function(a,b){if(-1<a.indexOf("://")&&6>a.indexOf("://")||0<=a.indexOf("magnet:"))return a;if(0===a.indexOf("//"))return"http:"+a;"/"!==a[0]&&(a="/"+a);return b+a},C=function(b,c){var e={id:b.url,wait:!1,favicon:b.site.favicon||v(b),torrent:{name:b.link.text,url:b.url},is_archive:b.is_archive,is_duplicate:!1,is_btfc_recommendation:b.is_btfc_recommendation,is_btfc_result:b.is_btfc_result,download:{}};b.downloads.magnets.length&&(e.download.magnet=b.downloads.magnets[0]);
b.downloads.torrents.length&&(e.download.torrent=D(b.downloads.torrents[0],b.url.getBaseUrl()));if(e.download.torrent&&!e.is_btfc_recommendation){var g=function(c){var g,d=0,h=[];try{g=sha1Hash(i.bencode(c.info))}catch(j){}if(c&&c.info)if(c.info.length)d=c.info.length;else if(c.info.files&&c.info.files.length)for(var m=0,k=c.info.files.length;m<k;m++)d+=c.info.files[m].length;g&&(e.hash=g.toUpperCase());d&&(e.files_size=d);c["announce-list"]?c["announce-list"].forEach(function(a){for(var b=0,c=a.length;b<
c;b++)h.push(a[b])}):h.push(c.announce);e.trackers=h;b.is_archive||(c.title?e.torrent.name=c.title:c.info.name&&(e.torrent.name=c.info.name));a.trigger("result",{data:e,query:b.query})};c?g(c):y(e.download.torrent).then(function(a){g(a)},function(){a.trigger("result",{data:e,query:b.query})})}else e.download.torrent&&e.is_btfc_recommendation?(e.recommended_genres=b.recommended_genres,e.order=b.order,a.trigger("result",{data:e,query:b.query})):e.download.magnet&&a.trigger("result",{data:e,query:b.query})},
y=function(a,b){var e=new $.Deferred,g={url:a,timeout:25E3,dataType:"binary"};(b?b.push(g):c.request(g)).then(function(a){var a=a.data,b;try{b=i.bdecode(a)}catch(c){}b&&b.info?e.resolve(b):e.reject()},function(){e.reject()});return e.promise()},u=function(a){return!(-1===a.indexOf("torrent")&&-1===a.indexOf("magnet"))};_.extend(b,{init:function(){m||(m=!0,c=_sandbox.request,a=_sandbox.observer.load("parser"),k.init(),k=k.RequestQueue,g.init(),a.on("check",p),a.on("spellcheck",n),a.on("check",function(){}))},
check_search:function(a){var b=new $.Deferred,c=new $.Deferred,e=a.url,g=e.getBaseUrl(),d=a.html;"http"!==g.substr(0,4)?c.reject(a):u(d)?c.resolve(a):e.strip("/")!==g?A(e).fail(function(){c.reject(a)}).done(function(b){_.extend(a,{url:g,html:b});u(b)?c.resolve(a):c.reject(a)}):c.reject(a);c.promise().then(function(a){var c;var e=a.html;c=a.url.getBaseUrl();for(var g=[],d=[],i=0,e=e.split("<form"),h=e.length;i<h;i++){var j=e[i];-1===j.indexOf("</form>")||-1===j.indexOf("search")&&-1===e[i-1].indexOf("search")||
g.push("<form"+j.split("</form>")[0]+"</form>")}i=0;for(h=g.length;i<h;i++)if(j=g[i],-1!==j.indexOf("action=")){var m,k=!1,l={};m=j.split("action=")[1].split(" ")[0].strip('"').strip("'").split('"')[0].split("'")[0];for(var n=0,e=j.split("<input"),u=e.length;n<u;n++){var p=e[n];if(-1!==p.indexOf('type="text"')||-1!==p.indexOf('type="search"')||-1!==p.indexOf("type='text'")||-1!==p.indexOf("type='search'"))j=p.split("name="),1<j.length&&(k=j[1].split(" ")[0].strip('"').strip("'").split('"')[0].split("'")[0]);
else if(-1!==p.indexOf('type="hidden"')||-1!==p.indexOf("type='hidden'"))j=p.split("name="),value_split=p.split("value="),1<j.length&&1<value_split.length&&(l[j[1].split(" ")[0].strip('"').strip("'").split('"')[0].split("'")[0]]=value_split[1].split(" ")[0].strip('"').strip("'").split('"')[0].split("'")[0])}k&&(0===m.indexOf(c)&&(m=m.replace(c,"")),d.push({url:D(m,c),param:k,hidden_els:l}))}0===d.length?c=!1:(d=d[d.length-1],d.favicon=a.favicon||v(a),c=d);c?q(c,"yesterday",!0).then(function(a){b.resolve(a)},
function(a){b.reject(a)}):b.reject(a)},function(){b.reject(a)});return b.promise()},query:function(a){var b=d.defer(),c=function(a){b.resolve(a)};q(a.site,a.query,!1).then(c,c);return b.promise}});return b})})();
(function(){define("sites","require underscore sandbox_helpers app_helpers parser config q".split(" "),function(){var b=require("sandbox_helpers"),d=require("config"),c=require("parser"),a="about: chrome:// chrome-devtools:// google. search.yahoo. yahoo. bing.".split(" "),e=null,g=null,i=null,h=null,k=null,l=!1,j,m={},n=function(a){t(a.key,a.silent)},p=function(a){var c=a.key,e=a.search,a=a.silent;delete g.get("skipped")[c];g.get("detected")[c]={time:b.getTimestamp(),data:e};a||(s(),j.trigger("detected",
e));g.save()},r=function(a){w(a.key)},q=function(a){a:{var b=a.key,a=C(),c;for(c in a)if(c===b){c=b;var a=g.get("added"),e=a[c];e&&delete a[c];g.save();s();j.trigger("disabled",e.data);break a}var d=g.get("declined");_.each(["detected","added"],function(a){var a=g.get(a),c=a[b];c&&(delete a[b],d[b]=c,j.trigger("disabled",c.data))});g.save();s()}},s=function(){j.trigger("reset",D())},x=function(a){_.isObject(a.skip)&&g.set({skipped:a.skip}).remove("skip").save();_.each(a.detected,function(a){j.trigger("detected",
a.data)});j.trigger("defaults",a.defaults)},t=function(a){g.get("skipped")[a]={time:b.getTimestamp()};g.save()},w=function(a){var b=C(),c;for(c in b)if(c===a)return z(a,b);var e=g.get("added");_.each(["detected","declined"],function(b){var b=g.get(b),c=b[a];c&&(delete b[a],e[a]=c,j.trigger("enabled",c.data))});g.save();s()},z=function(a,c){var e=g.get("added");_.each(_.keys(c),function(a){e[a]&&delete e[a]});var d=b.clone(c[a]);e[a]=_.clone(d);j.trigger("enabled",d.data);g.save();s()},B=function(a){if((a=
i.get(a))&&v(a.url))t(b.getBasePath(a.url)),a.inject(k)},A=function(a,c){var g=c.split("_")[1];(g=i.get(g))&&e.trigger("check",{url:g.url,html:a.html,favicon:g.favicon,key:b.getBasePath(g.url)})},v=function(c){if(!c)return!1;for(var c=c.getBasePath(),e,d=0,i=a.length;d<i;d++)if(0===c.indexOf(a[d]))return!1;return void 0!==g.get("added")[c]||(e=g.get("detected")[c]&&!b.isExpired(e))||(e=g.get("declined")[c]&&!b.isExpired(e))||g.get("skipped")[c]&&!b.isExpired(e)?!1:!0},D=function(){return g.get()},
C=function(){return b.clone(g.get("defaults"))};_.extend(m,{init:function(){if(!l){l=!0;var a=_sandbox.storage.load("sources").get("manifest");h=_sandbox.message;j=_sandbox.observer.load("sites");c.init();e=_sandbox.observer.load("parser");k=a.cscripts.inject;g=_sandbox.storage.load("sites",{defaults:{added:{archive:{data:{favicon:"http://www.archive-it.org/static/icons/logo_IA.png",hidden_els:{output:"json",rows:"50",page:"1","fl[]":"identifier,title"},param:"q",url:"http://archive.org/advancedsearch.php"},
time:b.getTimestamp()},btfc:{data:{favicon:"../img/16x16-bt-icon-purple.png",hidden_els:{},type:"GET",url:d.app.btfc_url[d.env]},time:b.getTimestamp()}},detected:{},declined:{},skipped:{},defaults:{"isohunt.com":{data:{favicon:"http://static.isohunt.com/favicon.ico",hidden_els:{},param:"ihq",url:"http://isohunt.com/torrents/"},time:b.getTimestamp()},google:{data:{favicon:null,hidden_els:{},param:"q",url:"http://www.google.com/search"},time:b.getTimestamp()},bing:{data:{favicon:null,hidden_els:{},param:"q",url:"http://www.bing.com/search"},time:b.getTimestamp()},yahoo:{data:{favicon:null,hidden_els:{},param:"p",url:"http://search.yahoo.com/search"},
time:b.getTimestamp()}}}}).on("reset",x);i=_sandbox.tabs.init();i.observer.on("ready",B);h.on("html",A);e.on("rejected",n);e.on("detected",p);e.on("added",r);j.on("load",s);g.on("reset",s);j.on("enable",r);j.on("disable",q)}},should_check:v,observer:j,get:D,get_enabled:function(){return g.get("added")},get_defaults:C,add:w});return window._sites=m})})();
(function(){define("surf_link",["require","underscore"],function(){var b=null,d=null,c=!1,a=null,e=null,g={},i=function(c){c=b.get(c);c.url&&c.url.match(/(https?:\/\/)?(127.0.0.1|10.0.2.2):8000\/link\/.*/)&&c.inject(a)},h=function(a){e.trigger("torrent:add_url",a.content.torrent,a.content.title)};_.extend(g,{init:function(){if(!c){c=!0;var g=_sandbox.storage.load("sources").get("manifest");d=_sandbox.message;b=_sandbox.tabs.init();a=g.cscripts.link;e=_sandbox.observer.load("app");b.observer.on("ready",
i);d.on("sl:dlfc",h)}}});return window._surf_link=g})})();
(function(){define("notifications",["require","underscore","config","sandbox_helpers"],function(b){var d=b("config"),c=b("sandbox_helpers"),a=d.app.notifications,e=null,g=null,i=null,h=[],k="",b={},l=function(){w();e.trigger("reset",h)},j=function(b,c){var e=null,e="bt0_icon";"safari"===_config.browser&&(e="surf_icon_safari");switch(b){case a.SEARCH_SITE_DISCOVERED:e="app/img/"+e+"_add.png";break;case a.AUTHORIZE_PAIRING:e="app/img/"+e+"_auth.png";break;default:9<c&&(c="9+"),e=!c?"app/img/"+e+".png":
"app/img/"+e+"_"+c+".png"}return e},m=[],n=function(a){if(a){var b=_.contains(m,a),c=h.reduce(function(c,e,g){(e.id===a||b&&_.contains(m,e.id))&&c.push(g);return c},[]);_.each(c,function(a){h.splice(a,1)})}},p=function(a,b,e){if(a){for(var g,d=0,i=h.length;d<i;d++)if(h[d].id===a){g=h[d];break}a=g}else a=h;if(a){if(a.timestamp=c.getTimestamp(),b)for(var j in b)"undefined"!==typeof a[j]&&(a[j]=b[j])}else return!1;(!e||!e.silent)&&l()},r=function(a,b){a=c.makeArray(a);_.each(a,function(a){_.each(h,function(c){if(!a||
c.type===a)c.resolved=!0,b||(c.seen=!0)})});l()},q=function(a,b){r.apply(this,arguments)},s=function(){p.apply(this,arguments)},x=function(){n.apply(this,arguments)},t=function(a){if((a=g.get(a))&&a.url&&a.url.getBasePath()!==k)k=a.url.getBasePath(),e.trigger("url",k),w()},w=function(){var a;a=_.filter(h,function(a){return!a.resolved&&50<=a.priority});var b=h.sort(function(a,b){return b.priority-a.priority}),b=_.map(b,function(a){return a.type}),b=b.shift();a=j(b,a.length);i.set_icon(a)};_.extend(b,
{init:function(){e=_sandbox.observer.load("notifications");g=_sandbox.tabs.init();i=_sandbox.popup;g.observer.on("current",t);e.on("load",l);e.on("resolve",q);e.on("update",s);e.on("remove",x);l=_.throttle(l,300)},clear:function(){h=[];compressed=[];l()},push:function(b,e){_.extend({resolved:!1,seen:!1,alert_seen:!1},b);b.id=b.id||c.generateGuid();b.img=b.img||j(b.type);b.name=b.name||"event name";b.action=b.action||"event action";b.timestamp=b.timestamp||c.getTimestamp();b.resolved=b.resolved||!1;
b.seen=b.seen||!1;b.alert_seen=b.alert_seen||!1;if(!b.priority)switch(b.type){case a.DOWNLOAD_COMPLETE:b.priority=70;break;case a.DOWNLOAD_FAILED:b.priority=30;break;case a.SEARCH_SITE_ADDED:case a.SEARCH_SITE_DECLINED:case a.SEARCH_SITE_ADD_FAIL:b.priority=30;n(b.id);break;case a.SEARCH_SITE_DISCOVERED:b.priority=90;break;case a.AUTHORIZE_PAIRING:b.priority=100;break;case a.DOWNLOAD_STARTED:b.priority=30;break;case a.CLIENT_AUTHORIZED:b.priority=1;break;default:b.priority=0}for(h.push(b);20<h.length;)h.shift();
(!e||!e.silent)&&l()},remove:n,set_default_engines:function(a){m=a}});return b})})();(function(){define("settings",["require","underscore","config"],function(b){var d={},c=b("underscore"),a=b("config"),e=null,g=!1;c.extend(d,{init:function(){g||(g=!0,e=_sandbox.storage.load("settings",{wait:300,defaults:a.app.settings_defaults}));return e}});return d})})();
(function(){define("download_urls",["require","underscore","sandbox_helpers"],function(b){b("sandbox_helpers");var d={},c=null,a=null,e=null,g=!1,i=function(a){for(var b=[],c=h(),e=0,g=a.length;e<g;e++)b.push(a[e].properties.uri);for(var d in c)0>b.indexOf(d)&&k(d)},h=function(a){return c.get(a)},k=function(a){return c.remove(a).save()};_.extend(d,{init:function(){g||(g=!0,a=_sandbox.observer.load("app"),e=_sandbox.observer.load("search"),c=_sandbox.storage.load("dl_urls",{wait:200}),c.save=_.debounce(_.bind(c.save,
c),200),a.on("torrents:ready",i));return d},remove_by_hash:function(a){var b=c.get(),a=a.toUpperCase(),g;for(g in b)if(b[g]===a){k(g);break}e.trigger("load")},add:function(a,b){c.set(a,b).save()},get:h,clear:function(){c.clear()},remove:k,exists:function(a){return a&&c.get(a)},hash_exists:function(a){var b=!1,e=c.get(),g;for(g in e)if(e[g]===a){b=!0;break}return b}});return d})})();
var sjcl={cipher:{},hash:{},mode:{},misc:{},codec:{},exception:{corrupt:function(b){this.toString=function(){return"CORRUPT: "+this.message};this.message=b},invalid:function(b){this.toString=function(){return"INVALID: "+this.message};this.message=b},bug:function(b){this.toString=function(){return"BUG: "+this.message};this.message=b}}};
sjcl.cipher.aes=function(b){this._tables[0][0][0]||this._precompute();var d,c,a,e,g=this._tables[0][4],i=this._tables[1];d=b.length;var h=1;if(4!==d&&6!==d&&8!==d)throw jQuery.jStorage.set("falconStore.sessionKey",null),new sjcl.exception.invalid("invalid aes key size");this._key=[a=b.slice(0),e=[]];for(b=d;b<4*d+28;b++){c=a[b-1];if(0===b%d||8===d&&4===b%d)c=g[c>>>24]<<24^g[c>>16&255]<<16^g[c>>8&255]<<8^g[c&255],0===b%d&&(c=c<<8^c>>>24^h<<24,h=h<<1^283*(h>>7));a[b]=a[b-d]^c}for(d=0;b;d++,b--)c=a[d&
3?b:b-4],e[d]=4>=b||4>d?c:i[0][g[c>>>24]]^i[1][g[c>>16&255]]^i[2][g[c>>8&255]]^i[3][g[c&255]]};
sjcl.cipher.aes.prototype={encrypt:function(b){return this._crypt(b,0)},decrypt:function(b){return this._crypt(b,1)},_tables:[[[],[],[],[],[]],[[],[],[],[],[]]],_precompute:function(){var b=this._tables[0],d=this._tables[1],c=b[4],a=d[4],e,g,i,h=[],k=[],l,j,m,n;for(e=0;256>e;e++)k[(h[e]=e<<1^283*(e>>7))^e]=e;for(g=i=0;!c[g];g^=l||1,i=k[i]||1){m=i^i<<1^i<<2^i<<3^i<<4;m=m>>8^m&255^99;c[g]=m;a[m]=g;j=h[e=h[l=h[g]]];n=16843009*j^65537*e^257*l^16843008*g;j=257*h[m]^16843008*m;for(e=0;4>e;e++)b[e][g]=j=
j<<24^j>>>8,d[e][m]=n=n<<24^n>>>8}for(e=0;5>e;e++)b[e]=b[e].slice(0),d[e]=d[e].slice(0)},_crypt:function(b,d){if(4!==b.length)throw new sjcl.exception.invalid("invalid aes block size");var c=this._key[d],a=b[0]^c[0],e=b[d?3:1]^c[1],g=b[2]^c[2],i=b[d?1:3]^c[3],h,k,l,j=c.length/4-2,m,n=4,p=[0,0,0,0];h=this._tables[d];var r=h[0],q=h[1],s=h[2],x=h[3],t=h[4];for(m=0;m<j;m++)h=r[a>>>24]^q[e>>16&255]^s[g>>8&255]^x[i&255]^c[n],k=r[e>>>24]^q[g>>16&255]^s[i>>8&255]^x[a&255]^c[n+1],l=r[g>>>24]^q[i>>16&255]^
s[a>>8&255]^x[e&255]^c[n+2],i=r[i>>>24]^q[a>>16&255]^s[e>>8&255]^x[g&255]^c[n+3],n+=4,a=h,e=k,g=l;for(m=0;4>m;m++)p[d?3&-m:m]=t[a>>>24]<<24^t[e>>16&255]<<16^t[g>>8&255]<<8^t[i&255]^c[n++],h=a,a=e,e=g,g=i,i=h;return p}};
sjcl.bitArray={bitSlice:function(b,d,c){b=sjcl.bitArray._shiftRight(b.slice(d/32),32-(d&31)).slice(1);return void 0===c?b:sjcl.bitArray.clamp(b,c-d)},concat:function(b,d){if(0===b.length||0===d.length)return b.concat(d);var c=b[b.length-1],a=sjcl.bitArray.getPartial(c);return 32===a?b.concat(d):sjcl.bitArray._shiftRight(d,a,c|0,b.slice(0,b.length-1))},bitLength:function(b){var d=b.length;return 0===d?0:32*(d-1)+sjcl.bitArray.getPartial(b[d-1])},clamp:function(b,d){if(32*b.length<d)return b;var b=
b.slice(0,Math.ceil(d/32)),c=b.length,d=d&31;0<c&&d&&(b[c-1]=sjcl.bitArray.partial(d,b[c-1]&2147483648>>d-1,1));return b},partial:function(b,d,c){return 32===b?d:(c?d|0:d<<32-b)+1099511627776*b},getPartial:function(b){return Math.round(b/1099511627776)||32},equal:function(b,d){if(sjcl.bitArray.bitLength(b)!==sjcl.bitArray.bitLength(d))return!1;var c=0,a;for(a=0;a<b.length;a++)c|=b[a]^d[a];return 0===c},_shiftRight:function(b,d,c,a){var e;e=0;for(void 0===a&&(a=[]);32<=d;d-=32)a.push(c),c=0;if(0===
d)return a.concat(b);for(e=0;e<b.length;e++)a.push(c|b[e]>>>d),c=b[e]<<32-d;e=b.length?b[b.length-1]:0;b=sjcl.bitArray.getPartial(e);a.push(sjcl.bitArray.partial(d+b&31,32<d+b?c:a.pop(),1));return a},_xor4:function(b,d){return[b[0]^d[0],b[1]^d[1],b[2]^d[2],b[3]^d[3]]}};
sjcl.codec.utf8String={fromBits:function(b){var d="",c=sjcl.bitArray.bitLength(b),a,e;for(a=0;a<c/8;a++)0===(a&3)&&(e=b[a/4]),d+=String.fromCharCode(e>>>24),e<<=8;return decodeURIComponent(escape(d))},toBits:function(b){var b=unescape(encodeURIComponent(b)),d=[],c,a=0;for(c=0;c<b.length;c++)a=a<<8|b.charCodeAt(c),3===(c&3)&&(d.push(a),a=0);c&3&&d.push(sjcl.bitArray.partial(8*(c&3),a));return d}};
sjcl.codec.hex={fromBits:function(b){var d="",c;for(c=0;c<b.length;c++)d+=((b[c]|0)+0xf00000000000).toString(16).substr(4);return d.substr(0,sjcl.bitArray.bitLength(b)/4)},toBits:function(b){var d,c=[],a,b=b.replace(/\s|0x/g,"");a=b.length;b+="00000000";for(d=0;d<b.length;d+=8)c.push(parseInt(b.substr(d,8),16)^0);return sjcl.bitArray.clamp(c,4*a)}};
sjcl.codec.base64={_chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(b,d){var c="",a,e=0,g=sjcl.codec.base64._chars,i=0,h=sjcl.bitArray.bitLength(b);for(a=0;6*c.length<h;)c+=g.charAt((i^b[a]>>>e)>>>26),6>e?(i=b[a]<<6-e,e+=26,a++):(i<<=6,e-=6);for(;c.length&3&&!d;)c+="=";return c},toBits:function(b){var b=b.replace(/\s|=/g,""),d=[],c,a=0,e=sjcl.codec.base64._chars,g=0,i;for(c=0;c<b.length;c++){i=e.indexOf(b.charAt(c));if(0>i)throw new sjcl.exception.invalid("this isn't base64!");
26<a?(a-=26,d.push(g^i>>>a),g=i<<32-a):(a+=6,g^=i<<32-a)}a&56&&d.push(sjcl.bitArray.partial(a&56,g,1));return d}};sjcl.codec.bytes={fromBits:function(b){var d=[],c=sjcl.bitArray.bitLength(b),a,e;for(a=0;a<c/8;a++)0===(a&3)&&(e=b[a/4]),d.push(e>>>24),e<<=8;return d},toBits:function(b){var d=[],c,a=0;for(c=0;c<b.length;c++)a=a<<8|b[c],3===(c&3)&&(d.push(a),a=0);c&3&&d.push(sjcl.bitArray.partial(8*(c&3),a));return d}};
sjcl.hash.sha256=function(b){this._key[0]||this._precompute();b?(this._h=b._h.slice(0),this._buffer=b._buffer.slice(0),this._length=b._length):this.reset()};sjcl.hash.sha256.hash=function(b){return(new sjcl.hash.sha256).update(b).finalize()};
sjcl.hash.sha256.prototype={blockSize:512,reset:function(){this._h=this._init.slice(0);this._buffer=[];this._length=0;return this},update:function(b){"string"===typeof b&&(b=sjcl.codec.utf8String.toBits(b));var d,c=this._buffer=sjcl.bitArray.concat(this._buffer,b);d=this._length;b=this._length=d+sjcl.bitArray.bitLength(b);for(d=512+d&-512;d<=b;d+=512)this._block(c.splice(0,16));return this},finalize:function(){var b,d=this._buffer,c=this._h,d=sjcl.bitArray.concat(d,[sjcl.bitArray.partial(1,1)]);for(b=
d.length+2;b&15;b++)d.push(0);d.push(Math.floor(this._length/4294967296));for(d.push(this._length|0);d.length;)this._block(d.splice(0,16));this.reset();return c},_init:[],_key:[],_precompute:function(){function b(a){return 4294967296*(a-Math.floor(a))|0}var d=0,c=2,a;a:for(;64>d;c++){for(a=2;a*a<=c;a++)if(0===c%a)continue a;8>d&&(this._init[d]=b(Math.pow(c,0.5)));this._key[d]=b(Math.pow(c,1/3));d++}},_block:function(b){for(var d,c,a=b.slice(0),e=this._h,g=this._key,i=e[0],h=e[1],k=e[2],l=e[3],j=e[4],
m=e[5],n=e[6],p=e[7],b=0;64>b;b++)16>b?d=a[b]:(d=a[b+1&15],c=a[b+14&15],d=a[b&15]=(d>>>7^d>>>18^d>>>3^d<<25^d<<14)+(c>>>17^c>>>19^c>>>10^c<<15^c<<13)+a[b&15]+a[b+9&15]|0),d=d+p+(j>>>6^j>>>11^j>>>25^j<<26^j<<21^j<<7)+(n^j&(m^n))+g[b],p=n,n=m,m=j,j=l+d|0,l=k,k=h,h=i,i=d+(h&k^l&(h^k))+(h>>>2^h>>>13^h>>>22^h<<30^h<<19^h<<10)|0;e[0]=e[0]+i|0;e[1]=e[1]+h|0;e[2]=e[2]+k|0;e[3]=e[3]+l|0;e[4]=e[4]+j|0;e[5]=e[5]+m|0;e[6]=e[6]+n|0;e[7]=e[7]+p|0}};
sjcl.mode.ccm={name:"ccm",encrypt:function(b,d,c,a,e){var g,i=d.slice(0),h=sjcl.bitArray,k=h.bitLength(c)/8,l=h.bitLength(i)/8,e=e||64,a=a||[];if(7>k)throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes");for(g=2;4>g&&l>>>8*g;g++);g<15-k&&(g=15-k);c=h.clamp(c,8*(15-g));d=sjcl.mode.ccm._computeTag(b,d,c,a,e,g);i=sjcl.mode.ccm._ctrMode(b,i,c,d,e,g);return h.concat(i.data,i.tag)},decrypt:function(b,d,c,a,e){var e=e||64,a=a||[],g=sjcl.bitArray,i=g.bitLength(c)/8,h=g.bitLength(d),k=g.clamp(d,
h-e),l=g.bitSlice(d,h-e),h=(h-e)/8;if(7>i)throw new sjcl.exception.invalid("ccm: iv must be at least 7 bytes");for(d=2;4>d&&h>>>8*d;d++);d<15-i&&(d=15-i);c=g.clamp(c,8*(15-d));k=sjcl.mode.ccm._ctrMode(b,k,c,l,e,d);b=sjcl.mode.ccm._computeTag(b,k.data,c,a,e,d);if(!g.equal(k.tag,b))throw new sjcl.exception.corrupt("ccm: tag doesn't match");return k.data},_computeTag:function(b,d,c,a,e,g){var i=[],h=sjcl.bitArray,k=h._xor4,e=e/8;if(e%2||4>e||16<e)throw new sjcl.exception.invalid("ccm: invalid tag length");
if(4294967295<a.length||4294967295<d.length)throw new sjcl.exception.bug("ccm: can't deal with 4GiB or more data");g=[h.partial(8,(a.length?64:0)|e-2<<2|g-1)];g=h.concat(g,c);g[3]|=h.bitLength(d)/8;g=b.encrypt(g);if(a.length){c=h.bitLength(a)/8;65279>=c?i=[h.partial(16,c)]:4294967295>=c&&(i=h.concat([h.partial(16,65534)],[c]));i=h.concat(i,a);for(a=0;a<i.length;a+=4)g=b.encrypt(k(g,i.slice(a,a+4).concat([0,0,0])))}for(a=0;a<d.length;a+=4)g=b.encrypt(k(g,d.slice(a,a+4).concat([0,0,0])));return h.clamp(g,
8*e)},_ctrMode:function(b,d,c,a,e,g){var i,h=sjcl.bitArray;i=h._xor4;var k=d.length,l=h.bitLength(d),c=h.concat([h.partial(8,g-1)],c).concat([0,0,0]).slice(0,4),a=h.bitSlice(i(a,b.encrypt(c)),0,e);if(!k)return{tag:a,data:[]};for(i=0;i<k;i+=4)c[3]++,e=b.encrypt(c),d[i]^=e[0],d[i+1]^=e[1],d[i+2]^=e[2],d[i+3]^=e[3];return{tag:a,data:h.clamp(d,l)}}};
sjcl.mode.ocb2={name:"ocb2",encrypt:function(b,d,c,a,e,g){if(128!==sjcl.bitArray.bitLength(c))throw new sjcl.exception.invalid("ocb iv must be 128 bits");var i,h=sjcl.mode.ocb2._times2,k=sjcl.bitArray,l=k._xor4,j=[0,0,0,0],c=h(b.encrypt(c)),m,n=[],a=a||[],e=e||64;for(i=0;i+4<d.length;i+=4)m=d.slice(i,i+4),j=l(j,m),n=n.concat(l(c,b.encrypt(l(c,m)))),c=h(c);m=d.slice(i);d=k.bitLength(m);i=b.encrypt(l(c,[0,0,0,d]));m=k.clamp(l(m.concat([0,0,0]),i),d);j=l(j,l(m.concat([0,0,0]),i));j=b.encrypt(l(j,l(c,
h(c))));a.length&&(j=l(j,g?a:sjcl.mode.ocb2.pmac(b,a)));return n.concat(k.concat(m,k.clamp(j,e)))},decrypt:function(b,d,c,a,e,g){if(128!==sjcl.bitArray.bitLength(c))throw new sjcl.exception.invalid("ocb iv must be 128 bits");for(var e=e||64,i=sjcl.mode.ocb2._times2,h=sjcl.bitArray,k=h._xor4,l=[0,0,0,0],j=i(b.encrypt(c)),m,n,p=sjcl.bitArray.bitLength(d)-e,r=[],a=a||[],c=0;c+4<p/32;c+=4)m=k(j,b.decrypt(k(j,d.slice(c,c+4)))),l=k(l,m),r=r.concat(m),j=i(j);n=p-32*c;m=b.encrypt(k(j,[0,0,0,n]));m=k(m,h.clamp(d.slice(c),
n).concat([0,0,0]));l=k(l,m);l=b.encrypt(k(l,k(j,i(j))));a.length&&(l=k(l,g?a:sjcl.mode.ocb2.pmac(b,a)));if(!h.equal(h.clamp(l,e),h.bitSlice(d,p)))throw new sjcl.exception.corrupt("ocb: tag doesn't match");return r.concat(h.clamp(m,n))},pmac:function(b,d){var c,a=sjcl.mode.ocb2._times2,e=sjcl.bitArray,g=e._xor4,i=[0,0,0,0],h=b.encrypt([0,0,0,0]),h=g(h,a(a(h)));for(c=0;c+4<d.length;c+=4)h=a(h),i=g(i,b.encrypt(g(h,d.slice(c,c+4))));c=d.slice(c);128>e.bitLength(c)&&(h=g(h,a(h)),c=e.concat(c,[-2147483648,
0,0,0]));i=g(i,c);return b.encrypt(g(a(g(h,a(h))),i))},_times2:function(b){return[b[0]<<1^b[1]>>>31,b[1]<<1^b[2]>>>31,b[2]<<1^b[3]>>>31,b[3]<<1^135*(b[0]>>>31)]}};sjcl.misc.hmac=function(b,d){this._hash=d=d||sjcl.hash.sha256;var c=[[],[]],a,e=d.prototype.blockSize/32;this._baseHash=[new d,new d];b.length>e&&(b=d.hash(b));for(a=0;a<e;a++)c[0][a]=b[a]^909522486,c[1][a]=b[a]^1549556828;this._baseHash[0].update(c[0]);this._baseHash[1].update(c[1])};
sjcl.misc.hmac.prototype.encrypt=sjcl.misc.hmac.prototype.mac=function(b,d){var c=(new this._hash(this._baseHash[0])).update(b,d).finalize();return(new this._hash(this._baseHash[1])).update(c).finalize()};
sjcl.misc.pbkdf2=function(b,d,c,a,e){c=c||1E3;if(0>a||0>c)throw sjcl.exception.invalid("invalid params to pbkdf2");"string"===typeof b&&(b=sjcl.codec.utf8String.toBits(b));var e=e||sjcl.misc.hmac,b=new e(b),g,i,h,k,l=[],j=sjcl.bitArray;for(k=1;32*l.length<(a||1);k++){e=g=b.encrypt(j.concat(d,[k]));for(i=1;i<c;i++){g=b.encrypt(g);for(h=0;h<g.length;h++)e[h]^=g[h]}l=l.concat(e)}a&&(l=j.clamp(l,a));return l};
sjcl.random={randomWords:function(b,d){var c=[],a;a=this.isReady(d);var e;if(a===this._NOT_READY)throw new sjcl.exception.notready("generator isn't seeded");a&this._REQUIRES_RESEED&&this._reseedFromPools(!(a&this._READY));for(a=0;a<b;a+=4)0===(a+1)%this._MAX_WORDS_PER_BURST&&this._gate(),e=this._gen4words(),c.push(e[0],e[1],e[2],e[3]);this._gate();return c.slice(0,b)},setDefaultParanoia:function(b){this._defaultParanoia=b},addEntropy:function(b,d,c){var c=c||"user",a,e,g=(new Date).valueOf(),i=this._robins[c],
h=this.isReady();a=this._collectorIds[c];void 0===a&&(a=this._collectorIds[c]=this._collectorIdNext++);void 0===i&&(i=this._robins[c]=0);this._robins[c]=(this._robins[c]+1)%this._pools.length;switch(typeof b){case "number":break;case "object":if(void 0===d)for(c=d=0;c<b.length;c++)for(e=b[c];0<e;)d++,e>>>=1;this._pools[i].update([a,this._eventId++,2,d,g,b.length].concat(b));break;case "string":void 0===d&&(d=b.length);this._pools[i].update([a,this._eventId++,3,d,g,b.length]);this._pools[i].update(b);
break;default:throw new sjcl.exception.bug("random: addEntropy only supports number, array or string");}this._poolEntropy[i]+=d;this._poolStrength+=d;h===this._NOT_READY&&(this.isReady()!==this._NOT_READY&&this._fireEvent("seeded",Math.max(this._strength,this._poolStrength)),this._fireEvent("progress",this.getProgress()))},isReady:function(b){b=this._PARANOIA_LEVELS[void 0!==b?b:this._defaultParanoia];return this._strength&&this._strength>=b?this._poolEntropy[0]>this._BITS_PER_RESEED&&(new Date).valueOf()>
this._nextReseed?this._REQUIRES_RESEED|this._READY:this._READY:this._poolStrength>=b?this._REQUIRES_RESEED|this._NOT_READY:this._NOT_READY},getProgress:function(b){b=this._PARANOIA_LEVELS[b?b:this._defaultParanoia];return this._strength>=b?1:this._poolStrength>b?1:this._poolStrength/b},startCollectors:function(){if(!this._collectorsStarted){if(window.addEventListener)window.addEventListener("load",this._loadTimeCollector,!1),window.addEventListener("mousemove",this._mouseCollector,!1);else if(document.attachEvent)document.attachEvent("onload",
this._loadTimeCollector),document.attachEvent("onmousemove",this._mouseCollector);else throw new sjcl.exception.bug("can't attach event");this._collectorsStarted=!0}},stopCollectors:function(){this._collectorsStarted&&(window.removeEventListener?(window.removeEventListener("load",this._loadTimeCollector),window.removeEventListener("mousemove",this._mouseCollector)):window.detachEvent&&(window.detachEvent("onload",this._loadTimeCollector),window.detachEvent("onmousemove",this._mouseCollector)),this._collectorsStarted=
!1)},addEventListener:function(b,d){this._callbacks[b][this._callbackI++]=d},removeEventListener:function(b,d){var c,a,e=this._callbacks[b],g=[];for(a in e)e.hasOwnProperty[a]&&e[a]===d&&g.push(a);for(c=0;c<g.length;c++)a=g[c],delete e[a]},_pools:[new sjcl.hash.sha256],_poolEntropy:[0],_reseedCount:0,_robins:{},_eventId:0,_collectorIds:{},_collectorIdNext:0,_strength:0,_poolStrength:0,_nextReseed:0,_key:[0,0,0,0,0,0,0,0],_counter:[0,0,0,0],_cipher:void 0,_defaultParanoia:6,_collectorsStarted:!1,_callbacks:{progress:{},
seeded:{}},_callbackI:0,_NOT_READY:0,_READY:1,_REQUIRES_RESEED:2,_MAX_WORDS_PER_BURST:65536,_PARANOIA_LEVELS:[0,48,64,96,128,192,256,384,512,768,1024],_MILLISECONDS_PER_RESEED:3E4,_BITS_PER_RESEED:80,_gen4words:function(){for(var b=0;4>b&&!(this._counter[b]=this._counter[b]+1|0,this._counter[b]);b++);return this._cipher.encrypt(this._counter)},_gate:function(){this._key=this._gen4words().concat(this._gen4words());this._cipher=new sjcl.cipher.aes(this._key)},_reseed:function(b){this._key=sjcl.hash.sha256.hash(this._key.concat(b));
this._cipher=new sjcl.cipher.aes(this._key);for(b=0;4>b&&!(this._counter[b]=this._counter[b]+1|0,this._counter[b]);b++);},_reseedFromPools:function(b){var d=[],c=0,a;this._nextReseed=d[0]=(new Date).valueOf()+this._MILLISECONDS_PER_RESEED;for(a=0;16>a;a++)d.push(4294967296*Math.random()|0);for(a=0;a<this._pools.length&&!(d=d.concat(this._pools[a].finalize()),c+=this._poolEntropy[a],this._poolEntropy[a]=0,!b&&this._reseedCount&1<<a);a++);this._reseedCount>=1<<this._pools.length&&(this._pools.push(new sjcl.hash.sha256),
this._poolEntropy.push(0));this._poolStrength-=c;c>this._strength&&(this._strength=c);this._reseedCount++;this._reseed(d)},_mouseCollector:function(b){sjcl.random.addEntropy([b.x||b.clientX||b.offsetX,b.y||b.clientY||b.offsetY],2,"mouse")},_loadTimeCollector:function(){sjcl.random.addEntropy(new Date,2,"loadtime")},_fireEvent:function(b,d){var c,a=sjcl.random._callbacks[b],e=[];for(c in a)a.hasOwnProperty(c)&&e.push(a[c]);for(c=0;c<e.length;c++)e[c](d)}};
sjcl.json={defaults:{v:1,iter:1E3,ks:128,ts:64,mode:"ccm",adata:"",cipher:"aes"},encrypt:function(b,d,c,a){var c=c||{},a=a||{},e=sjcl.json,g=e._add({iv:sjcl.random.randomWords(4,0)},e.defaults);e._add(g,c);"string"===typeof g.salt&&(g.salt=sjcl.codec.base64.toBits(g.salt));"string"===typeof g.iv&&(g.iv=sjcl.codec.base64.toBits(g.iv));if(!sjcl.mode[g.mode]||!sjcl.cipher[g.cipher]||"string"===typeof b&&100>=g.iter||64!==g.ts&&96!==g.ts&&128!==g.ts||128!==g.ks&&192!==g.ks&&256!==g.ks||2>g.iv.length||
4<g.iv.length)throw new sjcl.exception.invalid("json encrypt: invalid parameters");"string"===typeof b&&(c=sjcl.misc.cachedPbkdf2(b,g),b=c.key.slice(0,g.ks/32),g.salt=c.salt);"string"===typeof d&&(d=sjcl.codec.utf8String.toBits(d));c=new sjcl.cipher[g.cipher](b);e._add(a,g);a.key=b;g.ct=sjcl.mode[g.mode].encrypt(c,d,g.iv,g.adata,g.tag);return e.encode(e._subtract(g,e.defaults))},decrypt:function(b,d,c,a){var c=c||{},a=a||{},e=sjcl.json,d=e._add(e._add(e._add({},e.defaults),e.decode(d)),c,!0);"string"===
typeof d.salt&&(d.salt=sjcl.codec.base64.toBits(d.salt));"string"===typeof d.iv&&(d.iv=sjcl.codec.base64.toBits(d.iv));if(!sjcl.mode[d.mode]||!sjcl.cipher[d.cipher]||"string"===typeof b&&100>=d.iter||64!==d.ts&&96!==d.ts&&128!==d.ts||128!==d.ks&&192!==d.ks&&256!==d.ks||!d.iv||2>d.iv.length||4<d.iv.length)throw new sjcl.exception.invalid("json decrypt: invalid parameters");"string"===typeof b&&(c=sjcl.misc.cachedPbkdf2(b,d),b=c.key.slice(0,d.ks/32),d.salt=c.salt);c=new sjcl.cipher[d.cipher](b);c=sjcl.mode[d.mode].decrypt(c,
d.ct,d.iv,d.adata,d.tag);e._add(a,d);a.key=b;return sjcl.codec.utf8String.fromBits(c)},encode:function(b){var d,c="{",a="";for(d in b)if(b.hasOwnProperty(d)){if(!d.match(/^[a-z0-9]+$/i))throw new sjcl.exception.invalid("json encode: invalid property name");c+=a+d+":";a=",";switch(typeof b[d]){case "number":case "boolean":c+=b[d];break;case "string":c+='"'+escape(b[d])+'"';break;case "object":c+='"'+sjcl.codec.base64.fromBits(b[d],1)+'"';break;default:throw new sjcl.exception.bug("json encode: unsupported type");
}}return c+"}"},decode:function(b){b=b.replace(/\s/g,"");if(!b.match(/^\{.*\}$/))throw new sjcl.exception.invalid("json decode: this isn't json!");var b=b.replace(/^\{|\}$/g,"").split(/,/),d={},c,a;for(c=0;c<b.length;c++){if(!(a=b[c].match(/^([a-z][a-z0-9]*):(?:(\d+)|"([a-z0-9+\/%*_.@=\-]*)")$/i)))throw new sjcl.exception.invalid("json decode: this isn't json!");d[a[1]]=a[2]?parseInt(a[2],10):a[1].match(/^(ct|salt|iv)$/)?sjcl.codec.base64.toBits(a[3]):unescape(a[3])}return d},_add:function(b,d,c){void 0===
b&&(b={});if(void 0===d)return b;for(var a in d)if(d.hasOwnProperty(a)){if(c&&void 0!==b[a]&&b[a]!==d[a])throw new sjcl.exception.invalid("required parameter overridden");b[a]=d[a]}return b},_subtract:function(b,d){var c={},a;for(a in b)b.hasOwnProperty(a)&&b[a]!==d[a]&&(c[a]=b[a]);return c},_filter:function(b,d){var c={},a;for(a=0;a<d.length;a++)void 0!==b[d[a]]&&(c[d[a]]=b[d[a]]);return c}};sjcl.encrypt=sjcl.json.encrypt;sjcl.decrypt=sjcl.json.decrypt;sjcl.misc._pbkdf2Cache={};
sjcl.misc.cachedPbkdf2=function(b,d){var c=sjcl.misc._pbkdf2Cache,a,d=d||{};a=d.iter||1E3;c=c[b]=c[b]||{};a=c[a]=c[a]||{firstSalt:d.salt&&d.salt.length?d.salt.slice(0):sjcl.random.randomWords(2,0)};c=void 0===d.salt?a.firstSalt:d.salt;a[c]=a[c]||sjcl.misc.pbkdf2(b,c,d.iter);return{key:a[c].slice(0),salt:c.slice(0)}};define("sjcl",function(b){return function(){return b.sjcl}}(this));
(function(){define("btfc_search","require underscore parser settings sandbox_helpers q sjcl".split(" "),function(b){var d=b("q"),c=b("underscore"),a=b("sandbox_helpers"),e=b("settings"),g=b("parser"),i=b("sjcl"),h=null,k=!1,b={},l=function(){},j=function(b,c,e,d){0==d.length?e.resolve(b):(b=a.clone(b),b.url+="/api/recommend",b.hidden_els.g=d,g.query({query:c,site:b}).then(function(a){e.resolve(a)},function(a){e.resolve(a)}))};b.init=function(){k||(k=!0,_sandbox.observer.load("btfc_search"),g.init(),
e=e.init(),h=_sandbox.request)};b.search=function(b,e){var k=d.defer();if(c.isArray(e))j(b,e[0],k,e);else{var r=i.codec.hex.fromBits(i.hash.sha256.hash(e)),q=a.clone(b);q.url+="/api/lookup/"+r;q.cache_lookup_succeeded=!0;g.query({query:e,site:q}).then(function(a){a.cache_lookup_succeeded?k.resolve(a):h.request({url:"https://www.googleapis.com/freebase/v1/search",data:{query:e,key:"AIzaSyD2jLu5v1NMWak8iZRfe8AZQNHD_v_Ht14",filters:"(any type:/music/artist type:/music/album type:/book/book type:/film/film)",
mql_output:JSON.stringify({name:[],"/music/artist/genre":[],"/music/album/genre":[],"/film/film/genre":[],"/book/written_work/subjects":[],type:[]})},beforeSend:"emptyAjaxHeader",dataType:"json",timeout:1E4}).then(function(a){var c=[],a=JSON.parse(a.data);if("/api/status/ok"===a.code&&0<a.result.length)for(var g in a.result[0])/genre|subject/.test(g)&&c.push.apply(c,a.result[0][g]);g=c;0!==g.length&&(a=i.codec.hex.fromBits(i.hash.sha256.hash(e)),g=g.map(function(a){return"g="+a}),g={url:_config.app.btfc_url[_config.env]+
"/api/cache/"+a+"?"+g.join("&"),type:"PUT"},h.request(g).then(l,l));j(b,e,k,c)},function(a){k.resolve(a.data)})})}return k.promise};return b})})();
(function(){define("search","require underscore parser sites settings sandbox_helpers download_urls q btfc_search".split(" "),function(b){var d=b("q"),c=b("sandbox_helpers"),a=b("sites"),e=b("settings"),g=b("parser"),i=b("download_urls"),h=b("btfc_search"),k=null,l=null,j=null,m=null,n={query:"",results:{},history:[]},p=!1,r=!1,b={},q=function(){m.clear();r=!1;z()},s=function(a){var b=a.cached,e=a.query,g=!!v()[e],d=a.btfc_adv;m.set({query:e});m.save();if(a.query){var a=D(),i=a.indexOf(e);-1<i&&a.splice(i,
1);for(a.unshift(e);10<a.length;){var i=a.pop(),h=v();h[i]&&delete h[i];m.set("results",h);m.save()}m.set({history:a});k.trigger("history",a);m.save();b&&g?(a=c.getTimestamp(),i=v()[e],7200<a-i.time&&(g=!1,A(e,{time:c.getTimestamp(),data:{}}))):(!b&&g&&(g=!1),A(e,{time:c.getTimestamp(),data:{}}));d||l.trigger("spellcheck",{query:e});b&&g?(B(e),k.trigger("complete",e,!1)):x(e,d)}},x=function(b,e){var i=[];r="primary";k.trigger("search_start",b);if(e){var j=a.get_enabled().btfc;j&&(search=h.search(j.data,
[b]),i.push(search))}else _.each(a.get_enabled(),function(a){var c=null;(c=0<=a.data.url.indexOf(_config.app.btfc_url[_config.env])?h.search(a.data,b):g.query({query:b,site:a.data}))&&i.push(c)});c.track("search","submit",null,i.length);d.all(i).then(function(){w(b,"success")},function(){w(b,"fail")})},t={},w=function(a){var b=[];_.each(_.values(t[a]),function(a){b.push(a.promise)});d.all(b).then(function(){r=!1;k.trigger("complete",a,r);delete t[a]},function(){debugger});r="scrape";k.trigger("complete",
a,r)},z=function(){var a=m.get();k.trigger("history",a.history);B(a.query)},B=function(a){var b=[],c=v()[a];if(c)for(var e in c.data){var g=c.data[e];C(g)?g=_.extend(g,{downloaded:!0}):delete g.downloaded;b.push(g)}k.trigger("full_results",{searching:r,query:a,results:b,cached:!0})},A=function(a,b){var c=v();c[a]=b;m.set("results",c);m.save()},v=function(){return m.get("results")},D=function(){return m.get("history")},C=function(a){return a.download.torrent&&i.exists(a.download.torrent)||a.download.magnet&&
i.exists(a.download.magnet)||a.hash&&i.hash_exists(a.hash)?!0:!1},y=function(a){var b=a.data,a=a.query,e=v()[a],g;if(e){g=e.data[b.id];if(!g){if(b.download.magnet){if(g=c.parseMagnetLink(b.download.magnet),b.hash=g.hash,!b.trackers||b.trackers.length<g.trackers.length)b.trackers=g.trackers}else b.hash&&delete b.hash;g=e.data[b.id]=b}_.extend(g,b);g.download.magnet&&(!g.hash&&(!g.trackers||!g.trackers.length))&&_.extend(g,c.parseMagnetLink(g.download.magnet));if(g.is_duplicate){if(g.is_duplicate){if(g.scraped&&
!g.scraped.error&&(!e.data[g.is_duplicate].scraped||!e.data[g.is_duplicate].scraped.error))e.data[g.is_duplicate].scraped=c.clone(g.scraped);try{e.data[g.is_duplicate].duplicates[g.id]=c.clone(g)}catch(i){throw i.stack;}}}else{var h=_.filter(e.data,function(a){return a.id!==b.id&&b.hash&&a.hash===b.hash});if(h.length){for(var l=0,n=h.length;l<n;l++){var p=h[l],r=e.data[p.id];duplicates=g.duplicates||{};e.data[r.id].is_duplicate=b.id;delete r.duplicates;duplicates[p.id]=c.clone(r)}g.duplicates=duplicates}}C(g)&&
(g=_.extend(g,{downloaded:!0,skip_check:!0}));A(a,e);g.is_archive?g.scraped={downloaded:~~(1E3*Math.random()),complete:~~(100*Math.random()),incomplete:0}:!g.scraped&&(g.download.torrent||g.download.magnet)?(e=d.defer(),t[a]||(t[a]={}),t[a][g.id]=e,j.trigger("scrape",{query:a,data:g})):t[a]&&t[a][g.id]&&(e=t[a][g.id],e.resolve());a===m.get("query")&&k.trigger("result",g)}};_.extend(b,{init:function(){p||(p=!0,k=_sandbox.observer.load("search"),l=_sandbox.observer.load("parser"),j=_sandbox.observer.load("app"),
m=_sandbox.storage.load("search",{wait:1500,defaults:n}),i.init(),a.init(),g.init(),h.init(),e=e.init(),k.on("search",s),k.on("load",z),m.on("reset",z),k.on("clear",q),l.on("result",y),j.on("result",y))},observer:k,get_results:v,get_history:D,search:x});return b})})();
(function(){function b(a,b){if(!a)throw b;}function d(a){return"http://127.0.0.1:"+a+"/gui/pair?name="+encodeURIComponent(window.location.host)}b("undefined"!==typeof JSON,"JSON is a hard dependency");b("undefined"!==typeof _,"underscore/lodash is a hard dependency");b("undefined"!==typeof jQuery,"jQuery is a hard dependency");this.PairingView=Backbone.View.extend({initialize:function(){b("native"!==this.model.get("pairing_type"));this.model.on("pairing:authorize",this.authorize_iframe,this)},authorize_iframe:function(a){if("undefined"===
typeof jQuery.facebox)jQuery(document.createElement("link")).attr({href:"https://torque.bittorrent.com/facebox/src/facebox.css",type:"text/css",rel:"stylesheet"}).appendTo("head"),jQuery.getScript("https://torque.bittorrent.com/facebox/src/facebox.js",_.bind(this.authorize_iframe,this,a));else{jQuery.facebox.settings.overlay=!0;jQuery.facebox.settings.closeImage="https://torque.bittorrent.com/facebox/src/closelabel.png";jQuery.facebox.settings.loadingImage="https://torque.bittorrent.com/facebox/src/loading.gif";
jQuery.facebox.settings.opacity=0.6;var c=jQuery("<div></div>");c.attr("id","pairing");c.css("position","absolute");c.css("height","200px");c.css("width","400px");c.css("left","%50");c.css("margin-left","-200px");var e=jQuery("<iframe></iframe>"),d="https://torque.bittorrent.com/pairing/index.html?product="+this.model.get("product")+"&mime="+this.model.get("plugin_manager").get("mime_type")+"&name="+encodeURIComponent(document.title)+"&permissions=download,create,remote";e.attr("src",d);e.css("padding",
"0px");e.css("margin","0px");c.append(e);jQuery(window).on("message",function(c){if("https://torque.bittorrent.com"===c.originalEvent.origin){b(c&&c.originalEvent&&c.originalEvent.data,"no data was passed in the message from the iframe");if(40===c.originalEvent.data.length)a.deferred.resolve(c.originalEvent.data);else if("denied"===c.originalEvent.data)a.deferred.reject();else throw"the message data from the iframe was neither a pairing key, nor a denied message";jQuery(document).trigger("close.facebox");
jQuery("#pairing").remove()}});c.hide();jQuery("body").append(c);jQuery.facebox({div:"#pairing"})}}});var c={};this.PluginPairing={check_version:function(a){var b=new jQuery.Deferred;this.trigger("pairing:check_version",{port:a});this.get("plugin_manager").get_plugin().ajax("http://127.0.0.1:"+a+"/version/",_.bind(function(a){if(!a.allowed||!a.success)b.reject();else try{b.resolve(JSON.parse(a.data))}catch(c){b.reject()}},this));return b},authorize_basic:function(a){var b;a in c?b=c[a]:(b=new jQuery.Deferred,
c[a]=b,b.done(function(){delete c[a]}),this.get("plugin_manager").get_plugin().ajax(d(a),_.bind(function(a){!a.allowed||!a.success?b.reject():b.resolve(a.data)},this)));b.then(_.bind(this.authorize_port_success,this,a));b.fail(_.bind(this.authorize_port_error,this,a))}};var a={};this.JQueryPairing={check_version:function(a){this.trigger("pairing:check_version",{port:a});return jQuery.ajax({url:"http://127.0.0.1:"+a+"/version/",dataType:"jsonp",timeout:3E3})},authorize_basic:function(b){var c=_.bind(this.authorize_port_success,
this,b),e=_.bind(this.authorize_port_error,this,b),k;b in a?k=a[b]:(k=jQuery.ajax({url:d(b),dataType:"jsonp",timeout:3E3}),a[b]=k,k.done(function(){delete a[b]}));k.then(c);k.fail(e)}};var e={};this.Pairing=Backbone.Model.extend({defaults:{pairing_type:"iframe"},initialize:function(){_.bindAll(this,"on_check_version_success");b(!1===this.get("plugin")||this.get("plugin_manager"),"pairing is not intentionally avoiding the plugin, nor is it providing a plugin manager");this.get("plugin_manager")?_.extend(this,
PluginPairing):_.extend(this,JQueryPairing)},connect:function(){b(!this.session,"trying to port scan while one is already in progress");var a={abort:!1},c=[],e=_.after(5,_.bind(function(){!0!==a.abort&&(this.disconnect(),0===_.reduce(c,function(a,c){b("pending"!==c.state(),"executing pairing complete functionality while some queries are in flight");var e="resolved"===c.state();return a+(e?1:0)},0)&&this.trigger("pairing:stop"))},this));_.times(5,function(b){var b=7*Math.pow(b,3)+3*Math.pow(b,2)+5*
b+1E4,d=this.check_version(b);d.done(_.bind(function(){a.abort||this.on_check_version_success.apply(this,arguments)},this,b));c.push(d);d.always(e)},this);this.session=a},disconnect:function(){this.session&&(this.session.abort=!0,this.session=null)},on_check_version_success:function(a,b){var c={version:"object"===typeof b?b.version:"unknown",name:"object"===typeof b?b.name:"unknown",port:a,authorize:!0};if("invalid request"===b||b&&b.version)this.trigger("pairing:found",c),c.authorize&&this.authorize(a)},
authorize:function(a){var b;if(!(b="native"===this.get("pairing_type")))b=navigator.userAgent.match(/Macintosh/),b=void 0!==b&&null!==b;b?this.authorize_basic(a):(b=this.get("plugin_manager").get_plugin().pair(this.get("product")),40===b.length?this.authorize_port_success(a,b):(a in e?b=e[a]:(b=new jQuery.Deferred,e[a]=b,b.done(function(){delete e[a]}),this.trigger("pairing:authorize",{port:a,deferred:b})),b.then(_.bind(this.authorize_port_success,this,a)),b.fail(_.bind(this.authorize_port_error,
this,a))))},authorize_port_success:function(a,b){this.trigger("pairing:authorized",{port:a,key:b})},authorize_port_error:function(a){this.trigger("pairing:denied",a)}})}).call(this);define("pairing.btapp",["backbone"],function(b){return function(){return function(){window.PairingView=PairingView;window.PluginPairing=PluginPairing;window.JQueryPairing=JQueryPairing;window.Pairing=Pairing}.apply(b,arguments)}}(this));
(function(){function b(a,b){if(!a)throw b;}function d(a,b,c){var d=function(){a.call()?b.call():setTimeout(d,c||500)};_.defer(d)}b("undefined"!==typeof JSON,"JSON is a hard dependency");b("undefined"!==typeof _,"underscore/lodash is a hard dependency");b("undefined"!==typeof jQuery,"jQuery is a hard dependency");var c=_.memoize(function(a){var b=new jQuery.Deferred;document.createElement("object");var c=a+"_onload";window[c]=function(){b.resolve()};var d=document.createElement("div");jQuery(d).css({position:"absolute",
left:"-999em","z-index":-1});d.innerHTML='<object type="'+a+'" width="0" height="0"><param name="onload" value="'+c+'" /></object>';document.body.appendChild(d);return b});this.PluginManagerView=Backbone.View.extend({initialize:function(){this.model.on("plugin:install_plugin",this.download,this);this.model.on("plugin:plugin_updated",this.restart,this)},setup:function(a,b){"undefined"===typeof jQuery.facebox?(jQuery(document.createElement("link")).attr({href:"https://torque.bittorrent.com/facebox/src/facebox.css",
type:"text/css",rel:"stylesheet"}).appendTo("head"),jQuery.getScript("https://torque.bittorrent.com/facebox/src/facebox.js",_.bind(this.setup,this,a,b))):(jQuery.facebox.settings.overlay=!0,jQuery.facebox.settings.closeImage="https://torque.bittorrent.com/facebox/src/closelabel.png",jQuery.facebox.settings.loadingImage="https://torque.bittorrent.com/facebox/src/loading.gif",jQuery.facebox.settings.opacity=0.6,a.call(b))},restart:function(a){a.abort=!0;this.setup(function(){var a=jQuery("<div></div>");
a.attr("id","plugin_download");a.css("position","absolute");a.css("height","200px");a.css("width","400px");a.css("left","%50");a.css("margin-left","-200px");var b=jQuery("<p></p>");b.text("The "+this.model.get("product")+" plugin needs to complete an update. Please restart your browser.");a.append(b);a.hide();jQuery("body").append(a);jQuery.facebox({div:"#plugin_download"})},this)},download:function(a){a.install=!0;this.setup(function(){var a=jQuery("<div></div>");a.attr("id","plugin_download");a.css("position",
"absolute");a.css("height","200px");a.css("width","400px");a.css("left","%50");a.css("margin-left","-200px");var b=this.model.get("download_url"),b='<p style="text-align:center;">This site requires the '+this.model.get("product")+' plugin.<br><span style="font-size:8pt;">By installing this software, you<br>are agreeing to the <a href="http://www.bittorrent.com/legal/eula">EULA</a></span><br><br><a class="btn" id="download" href="'+b+'">Download</a></p>';a.append(b);this.model.on("plugin:plugin_installed",
function(){jQuery(document).trigger("close.facebox");jQuery("#plugin_download").remove()});a.hide();jQuery("body").append(a);jQuery.facebox({div:"#plugin_download"})},this)}});this.PluginManager=Backbone.Model.extend({soshare_props:{latest_version:"4.4.1",mime_type:"application/x-gyre-soshare",activex_progid:"gyre.soshare",windows_download_url:"https://torque.bittorrent.com/SoShare.msi",osx_download_url:"https://torque.bittorrent.com/SoShare.pkg"},torque_props:{latest_version:"4.3.8",mime_type:"application/x-bittorrent-torque",
activex_progid:"bittorrent.torque",windows_download_url:"https://torque.bittorrent.com/Torque.msi",osx_download_url:"https://torque.bittorrent.com/Torque.pkg"},defaults:{pid:"btapp_plugin_WARNING_HAVE_NOT_INITIALIZED",window_hash:"4823",product:"Torque"},initialize:function(){_.bindAll(this);this.set("pid","btapp_plugin_"+Math.floor(1024*Math.random()));"SoShare"===this.get("product")?_.each(this.soshare_props,function(a,b){this.has(b)||this.set(b,a)},this):("Torque"===this.get("product")||"uTorrent"===
this.get("product")||"BitTorrent"===this.get("product"))&&_.each(this.torque_props,function(a,b){this.has(b)||this.set(b,a)},this);var a=navigator.userAgent.match(/Macintosh/),a=void 0!==a&&null!==a?this.get("osx_download_url"):this.get("windows_download_url");this.set("download_url",a);jQuery(_.bind(_.defer,this,this.mime_type_check))},disconnect:function(){},mime_type_check:function(){this.supports_mime_type()?this.mime_type_check_yes():this.mime_type_check_no()},mime_type_check_no:function(){this.trigger("plugin:install_plugin",
{install:!1});d(this.supports_mime_type,this.mime_type_check_yes)},mime_type_check_yes:function(){this.trigger("plugin:plugin_installed");c(this.get("mime_type")).then(_.bind(function(){this.trigger("plugin:plugin_running");this.plugin_up_to_date_check()},this))},plugin_up_to_date_check:function(){this.plugin_up_to_date()?this.plugin_up_to_date_yes():this.plugin_up_to_date_no()},plugin_up_to_date_yes:function(){this.client_installed_check()},plugin_up_to_date_no:function(){var a={update:!0};this.trigger("plugin:update_plugin",
a);a.update?this.get_plugin().checkForUpdate(_.bind(this.plugin_up_to_date_yes,this)):this.plugin_up_to_date_yes()},client_installed_check:function(){this.client_installed()?this.client_installed_check_yes():this.client_installed_check_no()},client_installed_check_no:function(){var a={install:!0};this.trigger("plugin:install_client",a);a.install?(this.get_plugin().downloadProgram(this.get("product"),_.bind(function(a,b,c,d,k){jQuery.jStorage.set("pairing_key",k);this.trigger("plugin:downloaded_client")},
this)),d(this.client_installed,this.client_running_check_yes)):(a={check:!1},this.trigger("plugin:check_for_running_client",a),a.check&&this.client_running_check())},client_installed_check_yes:function(){this.trigger("plugin:client_installed");this.client_running_check()},client_running_check:function(){this.client_running()?this.client_running_check_yes():this.client_running_check_no()},client_running_check_no:function(){var a={run:!0};this.trigger("plugin:run_client",a);a.run&&this.get_plugin().runProgram(this.get("product"),
function(){});d(this.client_running,this.client_running_check_yes)},client_running_check_yes:function(){this.trigger("plugin:client_running")},supports_mime_type:function(){if("chrome-extension:"===window.location.protocol)return!0;if(-1!==navigator.appVersion.indexOf("MSIE"))try{return void 0!==new ActiveXObject(this.get("activex_progid"))}catch(a){return!1}else{navigator.plugins.refresh();for(var b=0;b<navigator.plugins.length;b++)if(navigator.plugins[b][0].type===this.get("mime_type"))return!0;
return!1}},plugin_up_to_date:function(){if("chrome-extension:"===window.location.protocol)return!0;for(var a=this.get_plugin().version,a=_.map(a.split("."),function(a){return parseInt(a,10)}),b=_.map(this.get("latest_version").split("."),function(a){return parseInt(a,10)}),c=0;c<a.length;c++){if(a[c]<b[c])return!1;if(a[c]>b[c])break}return!0},get_plugin:function(){var a=jQuery('[type="'+this.get("mime_type")+'"]');b(1===a.length,"cannot call get_plugin before adding the plugin");return a[0]},plugin_loaded:function(){b(this.supports_mime_type(),
"you have not installed the plugin yet");b(0!==jQuery("#"+this.get("pid")).length,"you have not yet added the plugin");return this.get_plugin().version},get_window_name:function(a){return"uTorrent"===a?"Torrent4823":a},client_running:function(){var a=this.get_plugin().isRunning(this.get_window_name(this.get("product")));return"object"===typeof a?a&&0<a.length:a},client_installed:function(){var a=this.get_plugin().getInstallVersion(this.get("product"));b("This application is not supported."!==a,"This application is not supported.");
return a}})}).call(this);define("plugin.btapp",["backbone","pairing.btapp"],function(b){return function(){return function(){window.PluginManagerView=PluginManagerView;window.PluginManager=PluginManager}.apply(b,arguments)}}(this));
(function(){function b(b,a){if(!b)throw a;}b("undefined"!==typeof JSON,"JSON is a hard dependency");b("undefined"!==typeof _,"underscore/lodash is a hard dependency");b("undefined"!==typeof PluginManager,"plugin.btapp.js is a hard dependency");b("undefined"!==typeof Pairing,"pairing.btapp.js is a hard dependency");b("undefined"!==typeof jQuery,"jQuery is a hard dependency");b("undefined"!==typeof jQuery.jStorage,"jQuery.jStorage is a hard dependency");var d=this;this.TorrentClient=Backbone.Model.extend({initialize:function(){this.btappCallbacks=
{}},storeCallbackFunction:function(b){for(var b=b||function(){},a="bt_",e=0;20>e||a in this.btappCallbacks;e++)a+=Math.floor(10*Math.random());this.btappCallbacks[a]=b;return a},isRPCFunctionSignature:function(c){b("string"===typeof c,"do not check function signature of non-strings");return c.match(/\[native function\](\([^\)]*\))+/)||c.match(/\[nf\](\([^\)]*\))+/)},isJSFunctionSignature:function(c){b("string"===typeof c,"do not check function signature of non-strings");return c.match(/\[nf\]bt_/)},
getStoredFunction:function(c){b(TorrentClient.prototype.isJSFunctionSignature(c),'only store functions that match the pattern "[nf]bt_*"');c=c.substring(4);b(c in this.btappCallbacks,"trying to get a function with a key that is not recognized");return this.btappCallbacks[c]},validateArguments:function(c,a){b("string"===typeof c,"expected functionValue to be a string");b("object"===typeof a,"expected variables to be an object");var e=c.match(/\(.*?\)/g);return _.any(e,function(b){b=b.match(/\w+/g)||
[];return b.length===a.length&&_.all(b,function(b,c){if("undefined"===typeof a[c])throw"client functions do not support undefined arguments";if("null"===typeof a[c])return!0;switch(b){case "number":case "string":case "boolean":return typeof a[c]===b;case "unknown":return!0;case "array":return"object"===typeof a[c];case "dispatch":return"object"===typeof a[c]||"function"===typeof a[c];default:throw"there is an invalid type in the function signature exposed by the client";}})})},convertCallbackFunctionArgs:function(b){_.each(b,
function(a,e){"function"===typeof a?b[e]=this.storeCallbackFunction(a):"object"===typeof a&&a&&this.convertCallbackFunctionArgs(a)},this)},createFunction:function(c,a,e){b(c,"cannot create a function without a session id");var d=_.bind(function(){var d=[],g;for(g=0;g<arguments.length;g++)d.push(arguments[g]);if(!TorrentClient.prototype.validateArguments.call(this,e,d))throw"arguments do not match any of the function signatures exposed by the client";this.convertCallbackFunctionArgs(d);var k=new jQuery.Deferred;
g=_.bind(function(c){_.each(a,function(a){a=decodeURIComponent(a);"undefined"!==typeof c&&(c=c[a])});if("undefined"===typeof c)k.reject("return value parsing error "+JSON.stringify(c));else if("string"===typeof c&&this.isJSFunctionSignature(c)){var e=this.getStoredFunction(c);b(e,"the client is returning a function name that does not exist");k.resolve(e)}else k.resolve(c)},this);this.query({type:"function",path:JSON.stringify(a),args:JSON.stringify(d),session:c}).done(g).fail(function(a){k.reject(a)});
this.trigger("queries",a);return k},this);d.valueOf=function(){return e};return d},query:function(c){var a=!1,e=new jQuery.Deferred;b("update"===c.type||"state"===c.type||"function"===c.type||"disconnect"===c.type,'the query type must be either "update", "state", or "function"');c.hostname=window.location.hostname||window.location.pathname;var d=_.bind(function(a){if("invalid request"===a)throw setTimeout(_.bind(this.reset,this),1E3),"pairing occured with a torrent client that does not support the btapp api";
"object"!==typeof a||"error"in a?(e.reject(),this.trigger("client:error",a)):e.resolve(a)},this);this.send_query(c).done(function(){a||d.apply(this,arguments)}).fail(function(){a||e.reject.apply(this,arguments)});e.abort=function(){a=!0};return e}});this.FalconTorrentClient=TorrentClient.extend({initialize:function(c){TorrentClient.prototype.initialize.call(this,c);b("username"in c&&"password"in c||"remote_data"in c,"attempting to connect to client through falcon without providing the necessary credentials");
this.username=c.username;this.password=c.password;"remote_data"in c&&(this.remote_data=c.remote_data);"login_success"in c&&(this.login_success=c.login_success);"login_error"in c&&(this.login_error=c.login_error);"login_progress"in c&&(this.login_progress=c.login_progress);"undefined"!==typeof falcon?_.defer(_.bind(this.reset,this)):(d.config={srp_root:"https://remote.utorrent.com"},jQuery.getScript("https://remote.utorrent.com/static/js/jsloadv2.js?v=0.57",_.bind(function(){for(var a="falcon/deps/SHA-1.js falcon/deps/jsbn.js falcon/deps/jsbn2.js falcon/deps/sjcl.js falcon/falcon.js falcon/falcon.encryption.js falcon/falcon.api.js falcon/falcon.session.js".split(" "),
b=[],c=[],d=0;d<a.length-1;d++){var h=a[d];b.push({name:h});c.push(h)}b.push({name:a[a.length-1],requires:c});(new JSLoad(b,"https://remote.utorrent.com/static/js/")).load(["falcon/falcon.session.js"],_.bind(function(){this.remote_data?(this.session=new falcon.session({client_data:this.remote_data}),this.falcon=this.session.api,this.trigger("client:connected")):this.delayed_reset()},this))},this)))},connect:function(){b(!this.falcon,"trying to connect with falcon already set");var c=_.bind(function(a){this.login_success&&
this.login_success(a);this.falcon=this.session;this.trigger("client:connected",a)},this),a=_.bind(function(a,b,c){this.login_error&&this.login_error(a,b,c);this.trigger("client:error_connecting",c);this.trigger("client:error",c)},this);this.session=new falcon.session;this.session.negotiate(this.username,this.password,{success:c,error:a,progress:this.login_progress})},disconnect:function(){},send_query:function(c){var a=new jQuery.Deferred;b(this.falcon,"cannot send a query to the client without falcon properly connected");
this.falcon.request("/gui/",{btapp:"backbone.btapp.js"},c,function(c){b("build"in c,"expected build information in the falcon response");b("result"in c,"expected result information in the falcon response");a.resolve(c.result)},_.bind(function(){a.reject();this.delayed_reset()},this),{});return a},delayed_reset:function(){this.reset_timeout=setTimeout(_.bind(function(){this.reset();this.reset_timeout=null},this),1E3)},reset:function(){this.falcon=null;this.connect()}});this.LocalTorrentClient=TorrentClient.extend({defaults:{product:"Torque"},
initialize:function(b){TorrentClient.prototype.initialize.call(this,b);this.btapp=b.btapp;this.initialize_objects(b);this.reset_timeout=null},disconnect:function(){this.pairing&&this.pairing.disconnect();this.plugin_manager&&this.plugin_manager.disconnect();this.reset_timeout&&clearTimeout(this.reset_timeout)},initialize_objects:function(b){this.initialize_plugin(b);this.initialize_pairing(b)},initialize_plugin:function(b){!1!==this.get("plugin")&&(this.plugin_manager=new PluginManager(b),new PluginManagerView({model:this.plugin_manager}),
this.plugin_manager.on("all",this.trigger,this))},initialize_pairing:function(c){b(!1===this.get("plugin")||"undefined"!==typeof this.plugin_manager,"you must initialize the plugin manager before the pairing object");this.pairing=new Pairing(_.extend(c,{plugin_manager:this.plugin_manager}));"native"!==this.pairing.get("pairing_type")&&new PairingView({model:this.pairing});this.pairing.on("all",this.trigger,this);b(this.has("product"),"client does not know what product to connect to");var a=this.get("product");
this.pairing.on("pairing:found",function(b){if(b&&b.name.toLowerCase()===a.toLowerCase()){var c=jQuery.jStorage.get(a+"_pairing_key");c?(b.abort=!0,b.authorize=!1,this.connect_to_authenticated_port(b.port,c)):(b.abort=!0,b.authorize=!0)}else b.abort=!1,b.authorize=!1},this);this.pairing.on("pairing:authorized",_.bind(function(b){jQuery.jStorage.set(a+"_pairing_key",b.key);this.connect_to_authenticated_port(b.port,b.key)},this));this.pairing.on("pairing:stop",this.delayed_reset,this);if(!1===this.get("plugin"))this.delayed_reset();
else this.plugin_manager.on("plugin:client_running",this.reset,this)},ajax:function(b,a,e){!1===this.get("plugin")?jQuery.ajax({url:b,success:a,error:e,dataType:"jsonp"}):this.plugin_manager.get_plugin().ajax(b,_.bind(function(b){var c;if(b.allowed&&b.success&&"invalid request"!==b.data){try{c=JSON.parse(b.data)}catch(d){e("parsererror");this.trigger("client:error","parsererror");return}a(c)}else this.trigger("client:error",b),e(b)},this))},connect_to_authenticated_port:function(b,a){var e=_.bind(function(){this.url=
"http://127.0.0.1:"+b+"/btapp/?pairing="+a;this.trigger("client:connected")},this),d=_.bind(function(){jQuery.jStorage.deleteKey(this.get("product")+"_pairing_key");this.delayed_reset()},this);this.ajax("http://127.0.0.1:"+b+"/btapp/?pairing="+a,e,d)},delayed_reset:function(){this.reset_timeout=setTimeout(_.bind(function(){this.reset();this.reset_timeout=null},this),1E3)},reset:function(){this.pairing.connect()},send_query:function(b){var a=new jQuery.Deferred;this.trigger("client:query",this.url,
b);var e=this.url;_.each(b,function(a,b){e+="&"+encodeURIComponent(b)+"="+encodeURIComponent(a)});this.ajax(e,function(b){a.resolve(b)},function(){a.reject()});return a}})}).call(this);define("client.btapp",["plugin.btapp","pairing.btapp","jstorage"],function(b){return function(){return function(){window.TorrentClient=TorrentClient;window.FalconTorrentClient=FalconTorrentClient;window.LocalTorrentClient=LocalTorrentClient}.apply(b,arguments)}}(this));
(function(){function b(a,b){if(!a)throw b;}function d(a){b(_.isString(a),"initial_selector takes a single argument");a=a.split(i);b(_.isArray(a));a=_.first(a);b(_.isString(a),"initial_selector should return a string");return a}function c(a){b(_.isString(a));var c,a=a.split(i);b(_.isArray(a));c=null;1<a.length&&(c=_.chain(a).rest().reduce(function(a,b){return a?a+i+b:b}).value(),b(_.isString(c)));return c}function a(a,c){b(_.toString(c));var e=_.clone(a||[]);e.unshift(c);return e}function e(c,e,d,
g,i){b(_.isNull(c)||_.isString(c));b(_.isFunction(e));c&&i&&!_.isUndefined(i.live)?i.live(c,e,d,a(g,i)):c||e.apply(d,a(g,i))}function g(e,d,g,i,j,h,l){var t,w;b(_.isFunction(e));b(_.isString(d));b(_.isFunction(g));b(_.isString(i));b(_.isFunction(j));t=this;w=function(b,B,A,v){var D;if(b=b===i)if(b=B===j)if(b=A===h)a:{var C,y,b=v||[];C=l||[];if(b.length!==C.length)b=!1;else{for(y=0;y<b.length&&y<C.length;y++)if(b[y]!==C[y]){b=!1;break a}b=!0}}b&&((D=c(i))&&e(function(b){_.isFunction(b.die)&&b.die(D,
B,A,a(v,b))}),t.off(d,g,t),k--,t.off("backbrace:die:"+i,w,t),k--)};t.on("backbrace:die:"+i,w,t);k++}var i=" ",h="*",k=0,l=0;this.Backbrace={setDelimiter:function(a){b(","!==a,"cannot use , as a delimiter as it will prevent event callbacks from being set properly");b(this.isClean(),"setting the delimiter after calling live can cause unexpected behavior");b(a!==h,"setting the delimiter to the same value as the wildcard can cause unexpected behavior");i=a},setWildcard:function(a){b(","!==a,"cannot use , as a wildcard as it will prevent event callbacks from being set properly");
b(this.isClean(),"setting the wildcard after calling live can cause unexpected behavior");b(a!==i,"setting the wildcard to the same value as the delimiter can cause unexpected behavior");h=a},isClean:function(){return 0===k&&0===l}};var j=function(a,c,e,d){b(_.isString(a));b(_.isFunction(c));this.trigger("backbrace:die:"+a,a,c,e,d);l--;return this};_.extend(Backbone.Collection.prototype,{die:j});_.extend(Backbone.Model.prototype,{die:j});_.extend(Backbone.Collection.prototype,{live:function(a,i,j,
r){b(_.isString(a));b(_.isFunction(i));var q,s,x,t,w;l++;q=this;s=d(a);x=c(a);b(_.isString(s));b(_.isNull(x)||_.isString(x));t=_.bind(e,this,x,i,j,r);x=function(a){s===h?q.each(a):q.get(s)&&a(q.get(s))};x(t);w=s===h?t:function(a){a.id===s&&t(a)};q.on("add",w,q);k++;g.call(q,x,"add",w,a,i,j,r);return q}});_.extend(Backbone.Model.prototype,{live:function(a,b,i,j){var q,s,x,t,w,z;l++;q=this;s=d(a);x=c(a);t=_.bind(e,this,x,b,i,j);x=function(a){s===h?_.each(q.toJSON(),a):q.has(s)&&a(q.get(s),s)};x(t);
s===h?(w="change",z=function(){_.each(q.changedAttributes(),function(a,b){_.isUndefined(q.previous(b))&&t(a)})}):(w="change:"+s,z=function(){var a;_.isUndefined(q.previous(s))&&(a=q.get(s),t(a))});q.on(w,z,q);k++;g.call(q,x,w,z,a,b,i,j);return q}})}).call(this);define("backbrace",["backbone"],function(b){return function(){return b.Backbrace}}(this));
(function(){function b(a,b){if(!a)throw b;}b("undefined"!==typeof JSON,"JSON is a hard dependency");b("undefined"!==typeof _,"underscore/lodash is a hard dependency");b("undefined"!==typeof TorrentClient,"client.btapp.js is a hard dependency");b("undefined"!==typeof jQuery,"jQuery is a hard dependency");b("undefined"!==typeof jQuery.jStorage,"jQuery.jStorage is a hard dependency");var d=function(a){return _.isObject(a)&&!_.isArray(a)&&jQuery.isEmptyObject(a)},c={initialize:function(){_.bindAll(this,
"initializeValues","updateState","clearState","isEmpty","destructor");this.initializeValues()},clearRemoteProcedureCalls:function(){for(var a=_.keys(this.bt||{}),b=0;b<a.length;b++){var c=a[b];delete this.bt[c];delete this[c]}this.bt={}},initializeValues:function(){this.session=this.path=null;this.clearRemoteProcedureCalls()},updateRemoveFunctionState:function(a){b(a in this.bt,"trying to remove a function that does not exist");this.trigger("remove:bt:"+a);this.trigger("remove:bt",this.bt[a],a);delete this.bt[a];
if(!("get"===a||"set"===a||"unset"===a||"length"===a))return b(a in this,'trying to remove the function "'+a+'", which does not exist in the prototype of this object'),this.trigger("remove:"+a),delete this[a],{}},updateRemoveObjectState:function(a,c,d,i,h){var k={},l=this.get(h);b(l,"trying to remove a model that does not exist");b("updateState"in l,"trying to remove an object that does not extend BtappBase");l.updateState(a,c,d,i);l.isEmpty()&&(k[h]=l,l.trigger("destroy"));return k},updateRemoveElementState:function(a,
b,c,d,h){h=_.clone(h||[]);h.push(d);if("all"===d)return this.updateState(this.session,b,c,h);if(_.isNull(c))return this.updateRemoveAttributeState(d,c);if(_.isObject(c)&&!_.isArray(c))return this.updateRemoveObjectState(a,b,c,h,d);if(_.isString(c)&&TorrentClient.prototype.isRPCFunctionSignature(c))return this.updateRemoveFunctionState(d);if(_.isString(c)&&TorrentClient.prototype.isJSFunctionSignature(c))return this.updateRemoveAttributeState(d,this.client.getStoredFunction(c));if("id"!==d)return this.updateRemoveAttributeState(d,
c)},updateRemoveState:function(a,b,c,d){var h={},k;for(k in c)void 0===b[k]&&_.extend(h,this.updateRemoveElementState(a,b[k],c[k],k,d));return h},updateAddFunctionState:function(a,c,d,i){d=_.clone(d||[]);d.push(i);a=this.client.createFunction(a,d,c);b(!(i in this.bt),"trying to add a function that already exists");this.bt[i]=a;"get"!==i&&("set"!==i&&"unset"!==i&&"length"!==i)&&(b(!(i in this),'trying to add the function "'+i+'", which already exists in the prototype of this object'),this[i]=a,this.trigger("add:"+
i));this.trigger("add:bt:"+i);this.trigger("add:bt",this.bt[i],i);return{}},updateAddObjectState:function(a,b,c,d,h){var a={},k=this.get(h);void 0===k&&(k=BtappCollection.prototype.verifyPath(d)?new BtappCollection:new BtappModel({id:h}),k.path=d,k.client=this.client,a[h]=k);k.updateState(this.session,b,c,d);return a},updateAddElementState:function(a,b,c,d,h){var k=_.clone(h||[]);k.push(d);_.isString(c)&&TorrentClient.prototype.isJSFunctionSignature(c)&&(c=this.client.getStoredFunction(c));return"all"===
d?this.updateState(this.session,b,c,k):_.isNull(b)?this.updateAddAttributeState(a,b,c,k,d):_.isObject(b)&&!_.isArray(b)?this.updateAddObjectState(a,b,c,k,d):_.isString(b)&&TorrentClient.prototype.isRPCFunctionSignature(b)?this.updateAddFunctionState(a,b,h,d):_.isString(b)&&TorrentClient.prototype.isJSFunctionSignature(b)?this.updateAddAttributeState(a,this.client.getStoredFunction(b),c,h,d):this.updateAddAttributeState(a,b,c,k,d)},updateAddState:function(a,b,c,d){var h={},k;for(k in b)_.extend(h,
this.updateAddElementState(a,b[k],c[k],k,d));return h},updateState:function(a,c,g,i){b(!d(c)||!d(g),'the client is outputing empty objects("'+i+'")...these should have been trimmed off');this.session=a;this.path||(this.path=i,b(this.verifyPath(this.path),"cannot updateState with an invalid collection path"));c=c||{};g=g||{};this.applyStateChanges(this.updateAddState(a,c,g,i),this.updateRemoveState(a,c,g,i))},sync:function(){}};this.BtappCollection=Backbone.Collection.extend(c).extend({initialize:function(a,
b){Backbone.Collection.prototype.initialize.apply(this,arguments);c.initialize.apply(this,arguments);this.on("add",this.customAddEvent,this);this.on("remove",this.customRemoveEvent,this);this.on("change",this.customChangeEvent,this)},customEvent:function(a,c){_.isFunction(c)||(b(c&&c.id,"called a custom "+a+" event without a valid attribute"),this.trigger(a+":"+c.id,c))},customAddEvent:function(a){this.customEvent("add",a)},customRemoveEvent:function(a){this.customEvent("remove",a)},customChangeEvent:function(a){this.customEvent("change",
a)},destructor:function(){this.off("add",this.customAddEvent,this);this.off("remove",this.customRemoveEvent,this);this.off("change",this.customChangeEvent,this);this.trigger("destroy")},clearState:function(){this.each(function(a){a.clearState()});this.initializeValues();this.reset();this.destructor()},verifyPath:function(a){return _.any([["btapp","torrent"],["btapp","torrent","all","*","file"],["btapp","torrent","all","*","peer"],["btapp","label"],["btapp","label","all","*","torrent"],"btapp label all * torrent all * file".split(" "),
"btapp label all * torrent all * peer".split(" "),["btapp","rss"],["btapp","rss","all","*","item"],["btapp","stream"],["btapp","stream","all","*","diskio"]],function(b){if(b.length!==a.length)return!1;for(var c=0;c<b.length;c++)if("*"!==b[c]&&b[c]!==a[c])return!1;return!0})},updateRemoveAttributeState:function(){throw"trying to remove an invalid type from a BtappCollection";},updateAddAttributeState:function(){throw"trying to add an invalid type to a BtappCollection";},isEmpty:function(){return d(this.bt)&&
0===this.length},applyStateChanges:function(a,b){this.add(_.values(a));this.remove(_.values(b))}});this.BtappModel=Backbone.Model.extend(c).extend({initialize:function(a){Backbone.Model.prototype.initialize.apply(this,arguments);c.initialize.apply(this,arguments);this.on("change",this.customEvents,this)},destructor:function(){this.off("change",this.customEvents,this);this.trigger("destroy")},clearState:function(){this.initializeValues();var a=_.clone(this.attributes);delete a.id;_.each(a,function(a){a&&
(_.isObject(a)&&a.hasOwnProperty("clearState"))&&a.clearState()});Backbone.Model.prototype.set.call(this,a,{internal:!0,unset:!0});this.destructor()},customEvents:function(){var a=this.changedAttributes();_.each(a,_.bind(function(a,b){if(void 0===a){var c=this.previous(b);this.trigger("remove",c,b);this.trigger("remove:"+b,c)}else void 0===this.previous(b)&&(this.trigger("add",a,b),this.trigger("add:"+b,a))},this))},verifyPath:function(){return!0},updateRemoveAttributeState:function(a,c){var d={};
b(this.get(a)===c,"trying to remove an attribute, but did not provide the correct previous value");d[a]=this.get(a);return d},updateAddAttributeState:function(a,c,d,i,h){a={};b(this.get(h)!==c,"trying to set a variable to the existing value ["+i+" -> "+JSON.stringify(c)+"]");void 0!==d&&b(this.get(h)===d,"trying to update an attribute, but did not provide the correct previous value");a[h]=c;return a},isEmpty:function(){var a=_.keys(this.toJSON());return d(this.bt)&&(0===a.length||1===a.length&&"id"===
a[0])},applyStateChanges:function(a,b){Backbone.Model.prototype.set.call(this,a,{internal:!0});Backbone.Model.prototype.set.call(this,b,{internal:!0,unset:!0})},set:function(a,b,c){var d=function(a,b){if(!(c&&"internal"in c)&&!_.isUndefined(this.get(b)))throw"please use save to set attributes directly to the client";};_.isObject(a)||null===a?_(a).each(d,this):d.call(this,b,a);return Backbone.Model.prototype.set.apply(this,arguments)},save:function(a){var b=[];_(a).each(function(a,c){b.push(this.bt.set(c,
a))},this);return jQuery.when.apply(jQuery,b)}});this.Btapp=BtappModel.extend({initialize:function(){BtappModel.prototype.initialize.apply(this,arguments);this.path=["btapp"];this.connected_state=!1;this.last_query=this.session=this.queries=this.client=null;_.bindAll(this,"connect","disconnect","connected","fetch","onEvents","onFetch","onConnectionError");this.on("add:events",this.setEvents,this)},destructor:function(){},connect:function(a){b(!this.client,"trying to connect to an undefined client");
b(!this.connected_state,"trying to connect when already connected");this.connected_state=!0;b(!this.session,"trying to create another session while one is active");a=a||{};this.poll_frequency=0;this.queries=a.queries||Btapp.QUERIES.ALL;b(_.isArray(this.queries),"the queries attribute must be an array of arrays of strings");b(_.all(this.queries,function(a){return _.isArray(a)&&_.all(a,function(a){return _.isString(a)})}),"the queries attribute must be an array of arrays of strings");a.btapp=this;b(!_.isUndefined(TorrentClient),
"client.btapp.js is a hard dependency");this.setClient(a);var c=new jQuery.Deferred,d=function(){this.off("client:connected",d,this);c.resolve()};this.on("client:connected",d,this);return c},setClient:function(a){"username"in a&&"password"in a||"remote_data"in a?(this.client=new FalconTorrentClient(a),this.client.bind("client:error_connecting",this.disconnect,this)):this.client=new LocalTorrentClient(a);this.client.bind("all",this.trigger,this);this.client.bind("client:connected",this.fetch)},setEvents:function(a){_.each(a.toJSON(),
function(b,c){if("id"!==c){var d={};d[c]=_.bind(this.trigger,this,c);a.save(d)}},this)},disconnect:function(){this.trigger("disconnect","manual");b(this.client,"trying to disconnect from an undefined client");b(this.connected_state,"trying to disconnect when not connected");this.session&&this.client.query({type:"disconnect",session:this.session});this.connected_state=!1;this.last_query&&(this.last_query.abort(),this.last_query=null);this.session=null;this.next_timeout&&clearTimeout(this.next_timeout);
this.client.disconnect();this.queries=this.client=this.client.btapp=null;this.clearState()},connected:function(){return this.connected_state},onConnectionError:function(){this.trigger("disconnect","error");this.poll_frequency=3E3;this.clearState();this.session=null;this.last_query&&(this.last_query.abort(),this.last_query=null);this.client&&_.delay(_.bind(this.client.reset,this.client),500)},onFetch:function(a){b("session"in a,"did not recieve a session id from the client");this.session=a.session;
this.waitForEvents(a.session)},fetch:function(){this.client&&(this.last_query=this.client.query({type:"state",queries:JSON.stringify(this.queries)}).done(this.onFetch).fail(this.onConnectionError))},onEvent:function(a,b){if("add"in b||"remove"in b)b.add=b.add||{},b.remove=b.remove||{},this.updateState(a,b.add.btapp,b.remove.btapp,["btapp"]);else if("callback"in b)this.client.btappCallbacks[b.callback](b.arguments);else throw"received invalid data from the client";},onEvents:function(a,c){b(this.session===
a,"should not receive data for a different session after creating a new one. do not forget to abort the last call of your old session.");if(this.connected_state){this.trigger("sync",c);this.poll_frequency=0===c.length?Math.min(3E3,this.poll_frequency+100):0;for(var d=0;d<c.length;d++)this.onEvent(a,c[d]);this.next_timeout=setTimeout(_.bind(this.waitForEvents,this,a),this.poll_frequency)}},waitForEvents:function(a){this.client&&(this.last_query=this.client.query({type:"update",session:a}).done(_.bind(this.onEvents,
this,a)).fail(this.onConnectionError))}});Btapp.VERSION="0.2.0";Btapp.QUERIES={ALL:[["btapp"]],DHT:[["btapp","dht"]],TORRENTS_BASIC:[["btapp","create"],["btapp","add","torrent"],"btapp torrent all * file all *".split(" "),"btapp torrent all * properties all *".split(" ")],EVENTS:[["btapp","events"]],SETTINGS:[["btapp","settings"]],REMOTE:[["btapp","connect_remote"],["btapp","settings","all","webui.uconnect_enable"]]};Btapp.STATUS={TORRENT:{DELETED:-1,DOWNLOAD_FAILED:0,ADDED:1,COMPLETE:2,METADATA_COMPLETE:3},
RSS_FEED:{DELETED:-1,ADDED:1}};Btapp.REMOVE={NO_DELETE:0,DELETE_TORRENT:1,DELETE_DATA:2,DELETE_BOTH:3,DELETE_TO_TRASH:4,DELETE_CONVERTED_FILES:5};Btapp.TORRENT={PRIORITY:{LOW:0,MEDIUM:1,HIGH:2,METADATA_ONLY:3},FILE:{PRIORITY:{NO_DOWNLOAD:0,LOW:5,MEDIUM:10,HIGH:15}},REMOVE:{NO_DELETE:0,DELETE_TORRENT:1,DELETE_DATA:2,DELETE_TORRENT_AND_DATA:3}}}).call(this);define("btapp",["client.btapp","plugin.btapp","pairing.btapp","backbone","backbrace"],function(b){return function(){return b.Btapp}}(this));
(function(){define("scraper",["require","underscore","q","sandbox_helpers"],function(b){var d=b("q"),c=b("sandbox_helpers"),a={},e=!1,g=["complete","incomplete","downloaded"],i=[],h=null,k=!1,l={},j=null,m=function(a){var b=a.query,e=a.data,g={},h;h=e.trackers;tracker=!1;if(h&&h.length)for(var t=0,w=h.length;t<w;t++){var z;z=h[t];var B=l[z];B?172800<c.getTimestamp()-B?(delete l[z],z=!1):z=!0:z=!1;if(!z){tracker=h[t];break}}h=tracker;if(e.hash&&h)g.hash=e.hash,g.tracker=h;else if(e.download.torrent)g.url=
e.download.torrent,g.tracker=h;else{j.observer.trigger("result",{data:_.extend(e,{scraped:{error:"no tracker or torrent"}}),query:b});return}h=d.defer();i.push({dfd:h,opts:g});k||(k=!0,n());h.promise.then(function(a){a.hash&&(a.hash=a.hash.toUpperCase(),e.hash=a.hash);j.observer.trigger("result",{data:_.extend(e,{scraped:a}),query:b})},function(d){if("app offline"===d)j.observer.trigger("result",{data:_.extend(e,{scraped:{error:d}}),query:b});else{if(g.tracker){var h=g.tracker;l[h]||(l[h]=c.getTimestamp())}_.defer(function(){g.tracker?
m(a):j.observer.trigger("result",{data:_.extend(e,{scraped:d}),query:b})})}})},n=function(){clearTimeout(h);if(i.length){var a=i.shift();j.client&&"Torque"===j.client.get("product")?(_.extend(a.opts,{callback:function(b){if(b.error)a.dfd.reject.apply(this,arguments);else{var c={},d=function(a,b){_.isObject(a)?_.each(a,d):c[b]=_.isString(a)&&!/[a-z]/i.test(a)?parseInt(a,10):a};_.each(b,d);var b=c,e=!1;_.each(_.keys(b),_.bind(function(a){if(_.include(g,a))return e=!0,!1},this));e?a.dfd.resolve(b):a.dfd.reject({error:"Nothing usable came back."})}}}),
j.get("tracker").scrape(a.opts)):a.dfd.reject("app offline");h=setTimeout(n,100)}else k=!1};_.extend(a,{init:function(b){e||(e=!0,j=b,j.observer.on("scrape",m));return a}});return a})})();
(function(){define("app.torque","require q config scraper download_urls sandbox_helpers btapp".split(" "),function(b){_.extend(Backbone.Model.prototype,{toDeepJSON:function(){var a=this.toJSON();_.each(a,function(b,c){if(b instanceof Backbone.Model||b instanceof Backbone.Collection)a[c]=b.toDeepJSON()});return a}});_.extend(Backbone.Collection.prototype,{toDeepJSON:function(a){return this.map(function(b){return b.toDeepJSON(a)})}});var d={},c=b("sandbox_helpers"),a=b("download_urls"),e=b("config"),
g=!1,i=null,h=null,k=b("scraper"),l=Btapp.extend({_connect_options:{mime_type:"safari"===_config.browser?"application/x-bittorrent-torque":"application/x-bittorrent-torquechrome",pairing_type:"native",product:"Torque",plugin:!1},observer:null,_scraper:null,initialize:function(){Btapp.prototype.initialize.apply(this,arguments);var a=this,b=_.debounce(function(){a.is_connected&&(a.is_connected=!1,a.disconnect());a.connect_with_plugin()},1E3,!0);this.reconnect=function(){b()};this.check_seeding_completed=
_.throttle(_.bind(this.check_seeding_completed,this),3E3);this.bind_events();this.bind_messages();this._scraper=k.init(this);this.assure_connect_timeout=setTimeout(_.bind(this.assure_connect,this),this.assure_connect_time)},bind_events:function(){var a=this;this.live("os",_.bind(this.on_os_ready,this));this.on("pairing:authorize",this.on_pairing_authorize,this);this.on("client:connected",this.on_client_connected,this);this.on("add:torrent",this.on_torrents,this);this.live("torrent *",function(b){b.live("properties",
function(c){c.on("change",_.bind(a.on_torrent_properties_change,a,b.id));c.on("change:completed_on",function(){b.trigger("complete",b)})})});this.live("settings",function(b){b.on("change",a.on_load_torque_settings,a)});this.on("client:query",this.before_sync,this);this.on("sync",this.on_sync,this)},bind_messages:function(){this.observer.on("alive",_.bind(this.on_plugin_worker_alive,this));this.observer.on("connected",_.bind(this.on_plugin_worker_connected,this));this.observer.on("torrents:load",_.bind(this.on_load_torrents,
this));this.observer.on("torrent:add_url",_.bind(this.on_action_add_by_url,this));this.observer.on("torrent:remove",_.bind(this.on_action_remove,this));this.observer.on("torrent:open",_.bind(this.on_open_folder,this));this.observer.on("torrent:pause",_.bind(this.on_action_pause,this));this.observer.on("torrent:start",_.bind(this.on_action_start,this));this.observer.on("settings:load",_.bind(this.on_load_torque_settings,this));this.observer.on("settings:set_dl_dir",_.bind(this.on_select_download_dir,
this));h.on("change:associate",_.bind(this.on_change_associate,this));this.observer.on("webui:open",_.bind(this.on_open_webui,this))},last_sync_request:0,unresponsive_time:1E4,hung_time:6E4,check_sync_timeout:null,assure_connect_timeout:null,assure_connect_time:15E3,is_connected:!1,on_sync:function(){this.check_seeding_completed();this.last_sync_request=0},before_sync:function(){this.last_sync_request=c.getTime()},on_client_connected:function(){this.is_connected=!0;this.continuously_check_sync()},
on_client_unresponsive:function(a){this.reconnect();if(0<this.last_sync_request&&a>this.hung_time)this.on_client_hung(a)},on_client_hung:function(){},continuously_check_sync:function(){clearTimeout(this.check_sync_timeout);var a=c.getTime();if(0<this.last_sync_request&&a-this.last_sync_request>this.unresponsive_time)this.on_client_unresponsive(a-this.last_sync_request);this.check_sync_timeout=setTimeout(_.bind(this.continuously_check_sync,this),this.unresponsive_time)},assure_connect:function(){clearTimeout(this.assure_connect_timeout);
this.is_connected||(this.reconnect(),this.assure_connect_timeout=setTimeout(_.bind(this.assure_connect,this),this.assure_connect_time))},on_os_ready:function(){this.on_change_associate(h.get("associate"))},on_change_associate:function(a){var b=this.get("os");a&&(b&&b.set_association)&&b.set_association()},on_open_webui:function(){if(this.client&&this.client.url){var a=this.get("settings"),b=a.get("webui.username"),c=a.get("webui.password"),d=a.get("bind_port"),e="http://"+b+":"+c+"@127.0.0.1:"+d+
"/gui",b=function(){_sandbox.tabs.open(e,!1,!0)};a.get("webui.enable")?b():a.save({"webui.enable":1}).done(b)}},on_torrents:function(a){a.on("add",this.on_torrent_added,this);a.on("complete",this.on_torrent_complete,this);a.on("remove",this.on_torrent_removed,this);_.defer(_.bind(function(){this.on_load_torrents()},this))},on_load_torrents:function(){var a=this.get("torrent"),a=a?a.toDeepJSON():[];this.observer.trigger("torrents:ready",a)},on_open_folder:function(a){(a=this.get("torrent").get(a))&&
a.open_containing()},on_select_download_dir:function(){var a=this;c.track("torque","settings","change_download_directory");this.browseforfolder(function(b){c.track("torque","settings","download_directory_changed",null);a.get("settings").save({dir_active_download:b,dir_active_download_flag:!0})})},on_load_torque_settings:function(){var a=this.get("settings");if(!a)return _.delay(_.bind(this.on_load_torque_settings,this),250);this.observer.trigger("settings:changed",a.toJSON())},on_action_add_by_url:function(b,
d){var e=this.get("add");a.add(b,!0);e&&_.isFunction(e.torrent)?(d&&0===b.indexOf("magnet:")&&(b=b.replace(/dn=[^&]+&?/i,""),b+=0>b.indexOf("?")?"?":"&",b+="dn="+encodeURIComponent(d)),e.torrent({url:b}).then(_.bind(function(a){"success"!==a?(this.observer.trigger("torrent:add_fail",b),c.track("torque","torrent","add_fail",1)):c.track("download","started",null,null)},this))):c.track("torque","torrent","add_fail",0)},on_action_remove:function(a,b){var d=this.get("torrent").get(a);d&&b?(d.remove(3),
c.track("torque","torrent","remove",3)):d?(d.remove(),c.track("torque","torrent","remove",1)):c.track("torque","torrent","remove",0)},on_action_pause:function(a){(a=this.get("torrent").get(a))?(a.pause(),c.track("torque","torrent","pause",1)):c.track("torque","torrent","pause",0)},on_action_start:function(a){(a=this.get("torrent").get(a))?(a.unpause(),c.track("torque","torrent","start",1)):c.track("torque","torrent","start",0)},on_torrent_added:function(b){var b=b.toDeepJSON(),c=a.get(b.properties.uri),
d=!!c;c?d&&a.add(b.properties.uri,b.id):a.add(b.properties.uri,b.id);this.observer.trigger("torrent:added",b,d)},on_torrent_complete:function(a){a.get("properties")&&a.get("properties").get("completed_on")&&(this.observer.trigger("torrent:completed",a.toDeepJSON()),c.track("download","complete",null,null))},on_torrent_removed:function(b){a.remove_by_hash(b.id);this.observer.trigger("torrent:removed",b.toDeepJSON())},on_torrent_properties_change:function(a,b,c){var d={},e;for(e in c.changes)d[e]=b.get(e);
this.observer.trigger("torrent:properties",a,d)},check_seeding_completed:function(){var a=this.get("torrent");if(!a)return!1;a.each(this.torrent_check_seeding_completed,this)},torrent_check_seeding_completed:function(a){var b,d,e=h.get();d=a.get("properties");if(0<d.get("completed_on")&&d.get("status")&1)if("time"===e.seed_type?(b=c.getTimestamp(),b=360<e.seed_time?-Infinity:b-60*e.seed_time,d=d.get("completed_on")<b):(b=e.seed_percentage/100,d=d.get("ratio")/1E3>=b),d)a.stop();else this.on_torrent_properties_change(a.id,
null,{changes:{}})},on_pairing_authorize:function(){},connect_with_plugin:function(){this._alive=!1;this.shake_hands()},_alive:!1,shake_hands:function(){this._alive||(this.observer.trigger("shake"),_.delay(_.bind(this.shake_hands,this),200))},on_plugin_worker_alive:function(){this._alive=!0;var a=c.clone(this._connect_options);a.plugin=!0;delete a.pairing_type;this.observer.trigger("connect",a)},on_plugin_worker_connected:function(a){jQuery.jStorage.set(this._connect_options.product+"_pairing_key",
a);this.connect(this._connect_options)}});_.extend(d,{init:function(){if(!g){g=!0;var b=function(){a.init();l.prototype.observer=_sandbox.observer.load("app");i=new l;i.connect_with_plugin();h.off("reset",b)};h=_sandbox.storage.load("settings",{wait:300,defaults:e.app.settings_defaults}).on("reset",b)}return i}});return d})})();
(function(){define("bench","require q underscore jquery sandbox_helpers sjcl".split(" "),function(b){var d={},c=b("underscore"),a=b("sandbox_helpers"),e=b("jquery"),g=b("sjcl"),b=_config,i=null,h=null,k=h=null,l=!1,j=null,m=b.app.TBS,n=b.app.TBV,p=b.app.TBN,h=function(){l=!0},r=function(){if(!l)return k.trigger("shake"),c.delay(r,200)},q=function(){if(l){var a;if(!(a=i.get("stat"))){a=window.navigator;data="";data+=a.appName;data+=a.appVersion;data+=a.platform;data+=a.userAgent;data+=void 0!==a.language?
a.language:a.browserLanguage;data+=a.product;data+=a.vendor;var b=window.navigator.plugins;a=0;for(var d=b.length;a<d;a++)data+=b[a].name+":"+b[a].filename;b=window.navigator.mimeTypes;a=0;for(d=b.length;a<d;a++)data+=b[a].description+":"+b[a].type;a=data+=(new Date).getTime();window.crypto&&window.crypto.getRandomValues?(d=new Uint32Array(1),window.crypto.getRandomValues(d),d=d[0]):d=Math.floor(Math.random()*(Math.pow(2,32)-1));data=a+d;a=g.codec.hex.fromBits(g.hash.sha256.hash(data));i.set("stat",
{tbs:m,tbv:n,tbn:p,sequenceID:0,uniqueID:a,ssb:0,last_checkin:0,popup_ct:0,popup_open:0,installed:!1}).save();a=i.get("stat")}j=a;u();x()}else return c.delay(q,200)},s=[],x=function(){if(s.length){var a=s.shift();t.apply(this,a);return c.delay(x,500)}},t=function(b,d,e,g){if(j){if(!b||!d)throw"both category and action are required for interaction analytics";"undefined"===typeof e&&(e=null);"undefined"===typeof g&&(g=null);var h={tb_category:b,tb_action:d,tb_label:e,tb_value:g},i=a.getTimestamp();
A(i);i=B(i,"ToolbarLog");a.extend(i,h);F(i)}else s.push(c.toArray(arguments))},w=0,b=function(){j&&(w=a.getTimestamp(),j.popup_ct+=1,v())},z=function(){if(j&&w){var b=a.getTimestamp()-w;w=0;j.popup_open+=b;v()}},B=function(b,c){var d=a.clone(j);d.eventName=c;d.ssb=b-d.ssb;delete d.last_checkin;delete d.popup_ct;delete d.popup_open;delete d.installed;return d},A=function(a){0===j.ssb&&(j.ssb=a);j.sequenceID+=1;v()},v=function(){i.set("stat",j).save()},D=function(b,c){var b=b||a.getTimestamp(),d;j.installed=
!0;A(b);d=B(b,"ToolbarLog");d.tb_category=c;d.tb_action=_sandbox.loader.get_manifest().meta.version;d.tb_label=_config.browser;d.tb_value=null;setTimeout(function(){F(d)},y())},C=function(b,c,d,e,g){var c=c||a.getTimestamp(),h,i;h=j[b];j[b]=0;A(c);i=B(c,"ToolbarLog");i.tb_category=d;i.tb_action=e;i.tb_label=g;i.tb_value=h;setTimeout(function(){F(i)},y())},y=function(){return~~(10*1E4*Math.random()*Math.random()/(10*Math.random()))},u=function(){var b=a.getTimestamp();if(86400<=b-j.last_checkin){j.installed?
(C("popup_ct",b,"interacted","popup",null),C("popup_open",b,"visible","popup",null)):D(b,"install");_config._install&&(_config._install=!1,D(b,"installed"));j.last_checkin=b;A(b);var b=B(b,"ToolbarLog"),c=~~(b.ssb/86400);b.tb_category="alive";b.tb_action=_sandbox.loader.get_manifest().meta.version;b.tb_label=_config.browser;b.tb_value=c;F(b)}return setTimeout(u,36E5)},F=function(a){var b=btoa(JSON.stringify(a));e.ajax({dataType:"jsonp",url:"http://bench.utorrent.com/e",data:{i:a.uniqueID,e:b}});k.trigger("track:event",
a)},i=_sandbox.storage.load("bench");i.on("reset",q);k=_sandbox.observer.load("gaq");k.on("alive",h);c.delay(h,2E4);r();h=_sandbox.observer.load("bench");h.on("track",t);h=_sandbox.observer.load("popup");h.on("open",b);h.on("close",z);c.extend(d,{});return d})})(this);
