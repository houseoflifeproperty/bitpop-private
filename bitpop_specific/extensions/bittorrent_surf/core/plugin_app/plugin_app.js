(function(){define("main",["require","plugin_app.require.config"],function(c,h){global_require.config(h);return{init:function(d,a){c(["config","btapp"],function(){_.extend(PluginManagerView.prototype,{download:function(){var a=this.model.toJSON();delete a.btapp;"application/x-bittorrent-torque"===a.mime_type&&_sandbox.extension_tabs.open({name:"plugin_install",plugin:a})}});var b=Btapp.extend({_connect_options:null,observer:a.observer.load("app"),initialize:function(){Btapp.prototype.initialize.apply(this,
arguments);this.bind_events();this.bind_messages()},bind_events:function(){this.on("all",console.warn,console);this.on("client:connected",this.on_client_connected,this);this.on("plugin:install_plugin",this.on_install_plugin,this);this.on("plugin:plugin_installed",this.on_plugin_installed,this);this.on("plugin:update_plugin",function(a){a.update=!1})},bind_messages:function(){this.observer.on("shake",_.bind(this.on_handshake,this));this.observer.on("connect",_.bind(this.on_connect,this));this.observer.on("get_state",
_.bind(this.on_plugin_state,this))},_plugin_state:!1,on_plugin_state:function(){this.observer.trigger("state",this._plugin_state.toString())},on_install_plugin:function(){this._plugin_state="plugin:install_plugin"},on_plugin_installed:function(){this._plugin_state&&(this._plugin_state=!1,this.on_plugin_state())},on_handshake:function(){this.observer.trigger("alive")},on_connect:function(a){if(this.connected()){if(this._plugin_state)return;this.disconnect()}this._connect_options=a;this.connect(this._connect_options)},
on_client_connected:function(){var a=jQuery.jStorage.get(this._connect_options.product+"_pairing_key");this.disconnect();this.observer.trigger("connected",a)},shutdown:function(){var a=new PluginManager(_.extend(this._connect_options,{btapp:this}));a.get_plugin().stopRunning(a.get("product"));a.destroy()}});$(document).ready(function(){window.plugin_app=new b})})}}})})(this);define("core/plugin_app",function(){});
(function(){function c(a,b){if(!a)throw b;}function h(a){return"http://127.0.0.1:"+a+"/gui/pair?name="+encodeURIComponent(window.location.host)}c("undefined"!==typeof JSON,"JSON is a hard dependency");c("undefined"!==typeof _,"underscore/lodash is a hard dependency");c("undefined"!==typeof jQuery,"jQuery is a hard dependency");this.PairingView=Backbone.View.extend({initialize:function(){c("native"!==this.model.get("pairing_type"));this.model.on("pairing:authorize",this.authorize_iframe,this)},authorize_iframe:function(a){if("undefined"===
typeof jQuery.facebox)jQuery(document.createElement("link")).attr({href:"https://torque.bittorrent.com/facebox/src/facebox.css",type:"text/css",rel:"stylesheet"}).appendTo("head"),jQuery.getScript("https://torque.bittorrent.com/facebox/src/facebox.js",_.bind(this.authorize_iframe,this,a));else{jQuery.facebox.settings.overlay=!0;jQuery.facebox.settings.closeImage="https://torque.bittorrent.com/facebox/src/closelabel.png";jQuery.facebox.settings.loadingImage="https://torque.bittorrent.com/facebox/src/loading.gif";
jQuery.facebox.settings.opacity=0.6;var b=jQuery("<div></div>");b.attr("id","pairing");b.css("position","absolute");b.css("height","200px");b.css("width","400px");b.css("left","%50");b.css("margin-left","-200px");var d=jQuery("<iframe></iframe>"),g="https://torque.bittorrent.com/pairing/index.html?product="+this.model.get("product")+"&mime="+this.model.get("plugin_manager").get("mime_type")+"&name="+encodeURIComponent(document.title)+"&permissions=download,create,remote";d.attr("src",g);d.css("padding",
"0px");d.css("margin","0px");b.append(d);jQuery(window).on("message",function(b){if("https://torque.bittorrent.com"===b.originalEvent.origin){c(b&&b.originalEvent&&b.originalEvent.data,"no data was passed in the message from the iframe");if(40===b.originalEvent.data.length)a.deferred.resolve(b.originalEvent.data);else if("denied"===b.originalEvent.data)a.deferred.reject();else throw"the message data from the iframe was neither a pairing key, nor a denied message";jQuery(document).trigger("close.facebox");
jQuery("#pairing").remove()}});b.hide();jQuery("body").append(b);jQuery.facebox({div:"#pairing"})}}});var d={};this.PluginPairing={check_version:function(a){var b=new jQuery.Deferred;this.trigger("pairing:check_version",{port:a});this.get("plugin_manager").get_plugin().ajax("http://127.0.0.1:"+a+"/version/",_.bind(function(a){if(!a.allowed||!a.success)b.reject();else try{b.resolve(JSON.parse(a.data))}catch(e){b.reject()}},this));return b},authorize_basic:function(a){var b;a in d?b=d[a]:(b=new jQuery.Deferred,
d[a]=b,b.done(function(){delete d[a]}),this.get("plugin_manager").get_plugin().ajax(h(a),_.bind(function(a){!a.allowed||!a.success?b.reject():b.resolve(a.data)},this)));b.then(_.bind(this.authorize_port_success,this,a));b.fail(_.bind(this.authorize_port_error,this,a))}};var a={};this.JQueryPairing={check_version:function(a){this.trigger("pairing:check_version",{port:a});return jQuery.ajax({url:"http://127.0.0.1:"+a+"/version/",dataType:"jsonp",timeout:3E3})},authorize_basic:function(b){var f=_.bind(this.authorize_port_success,
this,b),c=_.bind(this.authorize_port_error,this,b),d;b in a?d=a[b]:(d=jQuery.ajax({url:h(b),dataType:"jsonp",timeout:3E3}),a[b]=d,d.done(function(){delete a[b]}));d.then(f);d.fail(c)}};var b={};this.Pairing=Backbone.Model.extend({defaults:{pairing_type:"iframe"},initialize:function(){_.bindAll(this,"on_check_version_success");c(!1===this.get("plugin")||this.get("plugin_manager"),"pairing is not intentionally avoiding the plugin, nor is it providing a plugin manager");this.get("plugin_manager")?_.extend(this,
PluginPairing):_.extend(this,JQueryPairing)},connect:function(){c(!this.session,"trying to port scan while one is already in progress");var a={abort:!1},b=[],d=_.after(5,_.bind(function(){!0!==a.abort&&(this.disconnect(),0===_.reduce(b,function(a,b){c("pending"!==b.state(),"executing pairing complete functionality while some queries are in flight");var e="resolved"===b.state();return a+(e?1:0)},0)&&this.trigger("pairing:stop"))},this));_.times(5,function(c){var c=7*Math.pow(c,3)+3*Math.pow(c,2)+5*
c+1E4,n=this.check_version(c);n.done(_.bind(function(){a.abort||this.on_check_version_success.apply(this,arguments)},this,c));b.push(n);n.always(d)},this);this.session=a},disconnect:function(){this.session&&(this.session.abort=!0,this.session=null)},on_check_version_success:function(a,b){var c={version:"object"===typeof b?b.version:"unknown",name:"object"===typeof b?b.name:"unknown",port:a,authorize:!0};if("invalid request"===b||b&&b.version)this.trigger("pairing:found",c),c.authorize&&this.authorize(a)},
authorize:function(a){var f;if(!(f="native"===this.get("pairing_type")))f=navigator.userAgent.match(/Macintosh/),f=void 0!==f&&null!==f;f?this.authorize_basic(a):(f=this.get("plugin_manager").get_plugin().pair(this.get("product")),40===f.length?this.authorize_port_success(a,f):(a in b?f=b[a]:(f=new jQuery.Deferred,b[a]=f,f.done(function(){delete b[a]}),this.trigger("pairing:authorize",{port:a,deferred:f})),f.then(_.bind(this.authorize_port_success,this,a)),f.fail(_.bind(this.authorize_port_error,
this,a))))},authorize_port_success:function(a,b){this.trigger("pairing:authorized",{port:a,key:b})},authorize_port_error:function(a){this.trigger("pairing:denied",a)}})}).call(this);define("pairing.btapp",["backbone"],function(c){return function(){return function(){window.PairingView=PairingView;window.PluginPairing=PluginPairing;window.JQueryPairing=JQueryPairing;window.Pairing=Pairing}.apply(c,arguments)}}(this));
(function(){function c(a,b){if(!a)throw b;}function h(a,b,e){var f=function(){a.call()?b.call():setTimeout(f,e||500)};_.defer(f)}c("undefined"!==typeof JSON,"JSON is a hard dependency");c("undefined"!==typeof _,"underscore/lodash is a hard dependency");c("undefined"!==typeof jQuery,"jQuery is a hard dependency");var d=_.memoize(function(a){var b=new jQuery.Deferred;document.createElement("object");var e=a+"_onload";window[e]=function(){b.resolve()};var f=document.createElement("div");jQuery(f).css({position:"absolute",
left:"-999em","z-index":-1});f.innerHTML='<object type="'+a+'" width="0" height="0"><param name="onload" value="'+e+'" /></object>';document.body.appendChild(f);return b});this.PluginManagerView=Backbone.View.extend({initialize:function(){this.model.on("plugin:install_plugin",this.download,this);this.model.on("plugin:plugin_updated",this.restart,this)},setup:function(a,b){"undefined"===typeof jQuery.facebox?(jQuery(document.createElement("link")).attr({href:"https://torque.bittorrent.com/facebox/src/facebox.css",
type:"text/css",rel:"stylesheet"}).appendTo("head"),jQuery.getScript("https://torque.bittorrent.com/facebox/src/facebox.js",_.bind(this.setup,this,a,b))):(jQuery.facebox.settings.overlay=!0,jQuery.facebox.settings.closeImage="https://torque.bittorrent.com/facebox/src/closelabel.png",jQuery.facebox.settings.loadingImage="https://torque.bittorrent.com/facebox/src/loading.gif",jQuery.facebox.settings.opacity=0.6,a.call(b))},restart:function(a){a.abort=!0;this.setup(function(){var a=jQuery("<div></div>");
a.attr("id","plugin_download");a.css("position","absolute");a.css("height","200px");a.css("width","400px");a.css("left","%50");a.css("margin-left","-200px");var e=jQuery("<p></p>");e.text("The "+this.model.get("product")+" plugin needs to complete an update. Please restart your browser.");a.append(e);a.hide();jQuery("body").append(a);jQuery.facebox({div:"#plugin_download"})},this)},download:function(a){a.install=!0;this.setup(function(){var a=jQuery("<div></div>");a.attr("id","plugin_download");a.css("position",
"absolute");a.css("height","200px");a.css("width","400px");a.css("left","%50");a.css("margin-left","-200px");var e=this.model.get("download_url"),e='<p style="text-align:center;">This site requires the '+this.model.get("product")+' plugin.<br><span style="font-size:8pt;">By installing this software, you<br>are agreeing to the <a href="http://www.bittorrent.com/legal/eula">EULA</a></span><br><br><a class="btn" id="download" href="'+e+'">Download</a></p>';a.append(e);this.model.on("plugin:plugin_installed",
function(){jQuery(document).trigger("close.facebox");jQuery("#plugin_download").remove()});a.hide();jQuery("body").append(a);jQuery.facebox({div:"#plugin_download"})},this)}});this.PluginManager=Backbone.Model.extend({soshare_props:{latest_version:"4.4.1",mime_type:"application/x-gyre-soshare",activex_progid:"gyre.soshare",windows_download_url:"https://torque.bittorrent.com/SoShare.msi",osx_download_url:"https://torque.bittorrent.com/SoShare.pkg"},torque_props:{latest_version:"4.3.8",mime_type:"application/x-bittorrent-torque",
activex_progid:"bittorrent.torque",windows_download_url:"https://torque.bittorrent.com/Torque.msi",osx_download_url:"https://torque.bittorrent.com/Torque.pkg"},defaults:{pid:"btapp_plugin_WARNING_HAVE_NOT_INITIALIZED",window_hash:"4823",product:"Torque"},initialize:function(){_.bindAll(this);this.set("pid","btapp_plugin_"+Math.floor(1024*Math.random()));"SoShare"===this.get("product")?_.each(this.soshare_props,function(a,e){this.has(e)||this.set(e,a)},this):("Torque"===this.get("product")||"uTorrent"===
this.get("product")||"BitTorrent"===this.get("product"))&&_.each(this.torque_props,function(a,e){this.has(e)||this.set(e,a)},this);var a=navigator.userAgent.match(/Macintosh/),a=void 0!==a&&null!==a?this.get("osx_download_url"):this.get("windows_download_url");this.set("download_url",a);jQuery(_.bind(_.defer,this,this.mime_type_check))},disconnect:function(){},mime_type_check:function(){this.supports_mime_type()?this.mime_type_check_yes():this.mime_type_check_no()},mime_type_check_no:function(){this.trigger("plugin:install_plugin",
{install:!1});h(this.supports_mime_type,this.mime_type_check_yes)},mime_type_check_yes:function(){this.trigger("plugin:plugin_installed");d(this.get("mime_type")).then(_.bind(function(){this.trigger("plugin:plugin_running");this.plugin_up_to_date_check()},this))},plugin_up_to_date_check:function(){this.plugin_up_to_date()?this.plugin_up_to_date_yes():this.plugin_up_to_date_no()},plugin_up_to_date_yes:function(){this.client_installed_check()},plugin_up_to_date_no:function(){var a={update:!0};this.trigger("plugin:update_plugin",
a);a.update?this.get_plugin().checkForUpdate(_.bind(this.plugin_up_to_date_yes,this)):this.plugin_up_to_date_yes()},client_installed_check:function(){this.client_installed()?this.client_installed_check_yes():this.client_installed_check_no()},client_installed_check_no:function(){var a={install:!0};this.trigger("plugin:install_client",a);a.install?(this.get_plugin().downloadProgram(this.get("product"),_.bind(function(a,e,f,c,d){jQuery.jStorage.set("pairing_key",d);this.trigger("plugin:downloaded_client")},
this)),h(this.client_installed,this.client_running_check_yes)):(a={check:!1},this.trigger("plugin:check_for_running_client",a),a.check&&this.client_running_check())},client_installed_check_yes:function(){this.trigger("plugin:client_installed");this.client_running_check()},client_running_check:function(){this.client_running()?this.client_running_check_yes():this.client_running_check_no()},client_running_check_no:function(){var a={run:!0};this.trigger("plugin:run_client",a);a.run&&this.get_plugin().runProgram(this.get("product"),
function(){});h(this.client_running,this.client_running_check_yes)},client_running_check_yes:function(){this.trigger("plugin:client_running")},supports_mime_type:function(){if("chrome-extension:"===window.location.protocol)return!0;if(-1!==navigator.appVersion.indexOf("MSIE"))try{return void 0!==new ActiveXObject(this.get("activex_progid"))}catch(a){return!1}else{navigator.plugins.refresh();for(var b=0;b<navigator.plugins.length;b++)if(navigator.plugins[b][0].type===this.get("mime_type"))return!0;
return!1}},plugin_up_to_date:function(){if("chrome-extension:"===window.location.protocol)return!0;for(var a=this.get_plugin().version,a=_.map(a.split("."),function(a){return parseInt(a,10)}),b=_.map(this.get("latest_version").split("."),function(a){return parseInt(a,10)}),e=0;e<a.length;e++){if(a[e]<b[e])return!1;if(a[e]>b[e])break}return!0},get_plugin:function(){var a=jQuery('[type="'+this.get("mime_type")+'"]');c(1===a.length,"cannot call get_plugin before adding the plugin");return a[0]},plugin_loaded:function(){c(this.supports_mime_type(),
"you have not installed the plugin yet");c(0!==jQuery("#"+this.get("pid")).length,"you have not yet added the plugin");return this.get_plugin().version},get_window_name:function(a){return"uTorrent"===a?"Torrent4823":a},client_running:function(){var a=this.get_plugin().isRunning(this.get_window_name(this.get("product")));return"object"===typeof a?a&&0<a.length:a},client_installed:function(){var a=this.get_plugin().getInstallVersion(this.get("product"));c("This application is not supported."!==a,"This application is not supported.");
return a}})}).call(this);define("plugin.btapp",["backbone","pairing.btapp"],function(c){return function(){return function(){window.PluginManagerView=PluginManagerView;window.PluginManager=PluginManager}.apply(c,arguments)}}(this));
(function(){function c(c,a){if(!c)throw a;}c("undefined"!==typeof JSON,"JSON is a hard dependency");c("undefined"!==typeof _,"underscore/lodash is a hard dependency");c("undefined"!==typeof PluginManager,"plugin.btapp.js is a hard dependency");c("undefined"!==typeof Pairing,"pairing.btapp.js is a hard dependency");c("undefined"!==typeof jQuery,"jQuery is a hard dependency");c("undefined"!==typeof jQuery.jStorage,"jQuery.jStorage is a hard dependency");var h=this;this.TorrentClient=Backbone.Model.extend({initialize:function(){this.btappCallbacks=
{}},storeCallbackFunction:function(c){for(var c=c||function(){},a="bt_",b=0;20>b||a in this.btappCallbacks;b++)a+=Math.floor(10*Math.random());this.btappCallbacks[a]=c;return a},isRPCFunctionSignature:function(d){c("string"===typeof d,"do not check function signature of non-strings");return d.match(/\[native function\](\([^\)]*\))+/)||d.match(/\[nf\](\([^\)]*\))+/)},isJSFunctionSignature:function(d){c("string"===typeof d,"do not check function signature of non-strings");return d.match(/\[nf\]bt_/)},
getStoredFunction:function(d){c(TorrentClient.prototype.isJSFunctionSignature(d),'only store functions that match the pattern "[nf]bt_*"');d=d.substring(4);c(d in this.btappCallbacks,"trying to get a function with a key that is not recognized");return this.btappCallbacks[d]},validateArguments:function(d,a){c("string"===typeof d,"expected functionValue to be a string");c("object"===typeof a,"expected variables to be an object");var b=d.match(/\(.*?\)/g);return _.any(b,function(b){b=b.match(/\w+/g)||
[];return b.length===a.length&&_.all(b,function(b,e){if("undefined"===typeof a[e])throw"client functions do not support undefined arguments";if("null"===typeof a[e])return!0;switch(b){case "number":case "string":case "boolean":return typeof a[e]===b;case "unknown":return!0;case "array":return"object"===typeof a[e];case "dispatch":return"object"===typeof a[e]||"function"===typeof a[e];default:throw"there is an invalid type in the function signature exposed by the client";}})})},convertCallbackFunctionArgs:function(c){_.each(c,
function(a,b){"function"===typeof a?c[b]=this.storeCallbackFunction(a):"object"===typeof a&&a&&this.convertCallbackFunctionArgs(a)},this)},createFunction:function(d,a,b){c(d,"cannot create a function without a session id");var e=_.bind(function(){var e=[],i;for(i=0;i<arguments.length;i++)e.push(arguments[i]);if(!TorrentClient.prototype.validateArguments.call(this,b,e))throw"arguments do not match any of the function signatures exposed by the client";this.convertCallbackFunctionArgs(e);var g=new jQuery.Deferred;
i=_.bind(function(b){_.each(a,function(a){a=decodeURIComponent(a);"undefined"!==typeof b&&(b=b[a])});if("undefined"===typeof b)g.reject("return value parsing error "+JSON.stringify(b));else if("string"===typeof b&&this.isJSFunctionSignature(b)){var e=this.getStoredFunction(b);c(e,"the client is returning a function name that does not exist");g.resolve(e)}else g.resolve(b)},this);this.query({type:"function",path:JSON.stringify(a),args:JSON.stringify(e),session:d}).done(i).fail(function(a){g.reject(a)});
this.trigger("queries",a);return g},this);e.valueOf=function(){return b};return e},query:function(d){var a=!1,b=new jQuery.Deferred;c("update"===d.type||"state"===d.type||"function"===d.type||"disconnect"===d.type,'the query type must be either "update", "state", or "function"');d.hostname=window.location.hostname||window.location.pathname;var e=_.bind(function(a){if("invalid request"===a)throw setTimeout(_.bind(this.reset,this),1E3),"pairing occured with a torrent client that does not support the btapp api";
"object"!==typeof a||"error"in a?(b.reject(),this.trigger("client:error",a)):b.resolve(a)},this);this.send_query(d).done(function(){a||e.apply(this,arguments)}).fail(function(){a||b.reject.apply(this,arguments)});b.abort=function(){a=!0};return b}});this.FalconTorrentClient=TorrentClient.extend({initialize:function(d){TorrentClient.prototype.initialize.call(this,d);c("username"in d&&"password"in d||"remote_data"in d,"attempting to connect to client through falcon without providing the necessary credentials");
this.username=d.username;this.password=d.password;"remote_data"in d&&(this.remote_data=d.remote_data);"login_success"in d&&(this.login_success=d.login_success);"login_error"in d&&(this.login_error=d.login_error);"login_progress"in d&&(this.login_progress=d.login_progress);"undefined"!==typeof falcon?_.defer(_.bind(this.reset,this)):(h.config={srp_root:"https://remote.utorrent.com"},jQuery.getScript("https://remote.utorrent.com/static/js/jsloadv2.js?v=0.57",_.bind(function(){for(var a="falcon/deps/SHA-1.js falcon/deps/jsbn.js falcon/deps/jsbn2.js falcon/deps/sjcl.js falcon/falcon.js falcon/falcon.encryption.js falcon/falcon.api.js falcon/falcon.session.js".split(" "),
b=[],e=[],c=0;c<a.length-1;c++){var d=a[c];b.push({name:d});e.push(d)}b.push({name:a[a.length-1],requires:e});(new JSLoad(b,"https://remote.utorrent.com/static/js/")).load(["falcon/falcon.session.js"],_.bind(function(){this.remote_data?(this.session=new falcon.session({client_data:this.remote_data}),this.falcon=this.session.api,this.trigger("client:connected")):this.delayed_reset()},this))},this)))},connect:function(){c(!this.falcon,"trying to connect with falcon already set");var d=_.bind(function(a){this.login_success&&
this.login_success(a);this.falcon=this.session;this.trigger("client:connected",a)},this),a=_.bind(function(a,e,c){this.login_error&&this.login_error(a,e,c);this.trigger("client:error_connecting",c);this.trigger("client:error",c)},this);this.session=new falcon.session;this.session.negotiate(this.username,this.password,{success:d,error:a,progress:this.login_progress})},disconnect:function(){},send_query:function(d){var a=new jQuery.Deferred;c(this.falcon,"cannot send a query to the client without falcon properly connected");
this.falcon.request("/gui/",{btapp:"backbone.btapp.js"},d,function(b){c("build"in b,"expected build information in the falcon response");c("result"in b,"expected result information in the falcon response");a.resolve(b.result)},_.bind(function(){a.reject();this.delayed_reset()},this),{});return a},delayed_reset:function(){this.reset_timeout=setTimeout(_.bind(function(){this.reset();this.reset_timeout=null},this),1E3)},reset:function(){this.falcon=null;this.connect()}});this.LocalTorrentClient=TorrentClient.extend({defaults:{product:"Torque"},
initialize:function(c){TorrentClient.prototype.initialize.call(this,c);this.btapp=c.btapp;this.initialize_objects(c);this.reset_timeout=null},disconnect:function(){this.pairing&&this.pairing.disconnect();this.plugin_manager&&this.plugin_manager.disconnect();this.reset_timeout&&clearTimeout(this.reset_timeout)},initialize_objects:function(c){this.initialize_plugin(c);this.initialize_pairing(c)},initialize_plugin:function(c){!1!==this.get("plugin")&&(this.plugin_manager=new PluginManager(c),new PluginManagerView({model:this.plugin_manager}),
this.plugin_manager.on("all",this.trigger,this))},initialize_pairing:function(d){c(!1===this.get("plugin")||"undefined"!==typeof this.plugin_manager,"you must initialize the plugin manager before the pairing object");this.pairing=new Pairing(_.extend(d,{plugin_manager:this.plugin_manager}));"native"!==this.pairing.get("pairing_type")&&new PairingView({model:this.pairing});this.pairing.on("all",this.trigger,this);c(this.has("product"),"client does not know what product to connect to");var a=this.get("product");
this.pairing.on("pairing:found",function(b){if(b&&b.name.toLowerCase()===a.toLowerCase()){var e=jQuery.jStorage.get(a+"_pairing_key");e?(b.abort=!0,b.authorize=!1,this.connect_to_authenticated_port(b.port,e)):(b.abort=!0,b.authorize=!0)}else b.abort=!1,b.authorize=!1},this);this.pairing.on("pairing:authorized",_.bind(function(b){jQuery.jStorage.set(a+"_pairing_key",b.key);this.connect_to_authenticated_port(b.port,b.key)},this));this.pairing.on("pairing:stop",this.delayed_reset,this);if(!1===this.get("plugin"))this.delayed_reset();
else this.plugin_manager.on("plugin:client_running",this.reset,this)},ajax:function(c,a,b){!1===this.get("plugin")?jQuery.ajax({url:c,success:a,error:b,dataType:"jsonp"}):this.plugin_manager.get_plugin().ajax(c,_.bind(function(e){var c;if(e.allowed&&e.success&&"invalid request"!==e.data){try{c=JSON.parse(e.data)}catch(d){b("parsererror");this.trigger("client:error","parsererror");return}a(c)}else this.trigger("client:error",e),b(e)},this))},connect_to_authenticated_port:function(c,a){var b=_.bind(function(){this.url=
"http://127.0.0.1:"+c+"/btapp/?pairing="+a;this.trigger("client:connected")},this),e=_.bind(function(){jQuery.jStorage.deleteKey(this.get("product")+"_pairing_key");this.delayed_reset()},this);this.ajax("http://127.0.0.1:"+c+"/btapp/?pairing="+a,b,e)},delayed_reset:function(){this.reset_timeout=setTimeout(_.bind(function(){this.reset();this.reset_timeout=null},this),1E3)},reset:function(){this.pairing.connect()},send_query:function(c){var a=new jQuery.Deferred;this.trigger("client:query",this.url,
c);var b=this.url;_.each(c,function(a,c){b+="&"+encodeURIComponent(c)+"="+encodeURIComponent(a)});this.ajax(b,function(b){a.resolve(b)},function(){a.reject()});return a}})}).call(this);define("client.btapp",["plugin.btapp","pairing.btapp","jstorage"],function(c){return function(){return function(){window.TorrentClient=TorrentClient;window.FalconTorrentClient=FalconTorrentClient;window.LocalTorrentClient=LocalTorrentClient}.apply(c,arguments)}}(this));
(function(){function c(a,b){if(!a)throw b;}function h(a){c(_.isString(a),"initial_selector takes a single argument");a=a.split(f);c(_.isArray(a));a=_.first(a);c(_.isString(a),"initial_selector should return a string");return a}function d(a){c(_.isString(a));var b,a=a.split(f);c(_.isArray(a));b=null;1<a.length&&(b=_.chain(a).rest().reduce(function(a,b){return a?a+f+b:b}).value(),c(_.isString(b)));return b}function a(a,b){c(_.toString(b));var e=_.clone(a||[]);e.unshift(b);return e}function b(b,e,f,
d,i){c(_.isNull(b)||_.isString(b));c(_.isFunction(e));b&&i&&!_.isUndefined(i.live)?i.live(b,e,f,a(d,i)):b||e.apply(f,a(d,i))}function e(b,e,f,i,j,k,h){var l,n;c(_.isFunction(b));c(_.isString(e));c(_.isFunction(f));c(_.isString(i));c(_.isFunction(j));l=this;n=function(c,v,w,p){var x;if(c=c===i)if(c=v===j)if(c=w===k)a:{var t,r,c=p||[];t=h||[];if(c.length!==t.length)c=!1;else{for(r=0;r<c.length&&r<t.length;r++)if(c[r]!==t[r]){c=!1;break a}c=!0}}c&&((x=d(i))&&b(function(b){_.isFunction(b.die)&&b.die(x,
v,w,a(p,b))}),l.off(e,f,l),g--,l.off("backbrace:die:"+i,n,l),g--)};l.on("backbrace:die:"+i,n,l);g++}var f=" ",i="*",g=0,n=0;this.Backbrace={setDelimiter:function(a){c(","!==a,"cannot use , as a delimiter as it will prevent event callbacks from being set properly");c(this.isClean(),"setting the delimiter after calling live can cause unexpected behavior");c(a!==i,"setting the delimiter to the same value as the wildcard can cause unexpected behavior");f=a},setWildcard:function(a){c(","!==a,"cannot use , as a wildcard as it will prevent event callbacks from being set properly");
c(this.isClean(),"setting the wildcard after calling live can cause unexpected behavior");c(a!==f,"setting the wildcard to the same value as the delimiter can cause unexpected behavior");i=a},isClean:function(){return 0===g&&0===n}};var p=function(a,b,e,f){c(_.isString(a));c(_.isFunction(b));this.trigger("backbrace:die:"+a,a,b,e,f);n--;return this};_.extend(Backbone.Collection.prototype,{die:p});_.extend(Backbone.Model.prototype,{die:p});_.extend(Backbone.Collection.prototype,{live:function(a,f,p,
u){c(_.isString(a));c(_.isFunction(f));var j,k,m,l,q;n++;j=this;k=h(a);m=d(a);c(_.isString(k));c(_.isNull(m)||_.isString(m));l=_.bind(b,this,m,f,p,u);m=function(a){k===i?j.each(a):j.get(k)&&a(j.get(k))};m(l);q=k===i?l:function(a){a.id===k&&l(a)};j.on("add",q,j);g++;e.call(j,m,"add",q,a,f,p,u);return j}});_.extend(Backbone.Model.prototype,{live:function(a,c,f,p){var j,k,m,l,q,s;n++;j=this;k=h(a);m=d(a);l=_.bind(b,this,m,c,f,p);m=function(a){k===i?_.each(j.toJSON(),a):j.has(k)&&a(j.get(k),k)};m(l);
k===i?(q="change",s=function(){_.each(j.changedAttributes(),function(a,b){_.isUndefined(j.previous(b))&&l(a)})}):(q="change:"+k,s=function(){var a;_.isUndefined(j.previous(k))&&(a=j.get(k),l(a))});j.on(q,s,j);g++;e.call(j,m,q,s,a,c,f,p);return j}})}).call(this);define("backbrace",["backbone"],function(c){return function(){return c.Backbrace}}(this));
(function(){function c(a,b){if(!a)throw b;}c("undefined"!==typeof JSON,"JSON is a hard dependency");c("undefined"!==typeof _,"underscore/lodash is a hard dependency");c("undefined"!==typeof TorrentClient,"client.btapp.js is a hard dependency");c("undefined"!==typeof jQuery,"jQuery is a hard dependency");c("undefined"!==typeof jQuery.jStorage,"jQuery.jStorage is a hard dependency");var h=function(a){return _.isObject(a)&&!_.isArray(a)&&jQuery.isEmptyObject(a)},d={initialize:function(){_.bindAll(this,
"initializeValues","updateState","clearState","isEmpty","destructor");this.initializeValues()},clearRemoteProcedureCalls:function(){for(var a=_.keys(this.bt||{}),b=0;b<a.length;b++){var c=a[b];delete this.bt[c];delete this[c]}this.bt={}},initializeValues:function(){this.session=this.path=null;this.clearRemoteProcedureCalls()},updateRemoveFunctionState:function(a){c(a in this.bt,"trying to remove a function that does not exist");this.trigger("remove:bt:"+a);this.trigger("remove:bt",this.bt[a],a);delete this.bt[a];
if(!("get"===a||"set"===a||"unset"===a||"length"===a))return c(a in this,'trying to remove the function "'+a+'", which does not exist in the prototype of this object'),this.trigger("remove:"+a),delete this[a],{}},updateRemoveObjectState:function(a,b,e,f,d){var g={},h=this.get(d);c(h,"trying to remove a model that does not exist");c("updateState"in h,"trying to remove an object that does not extend BtappBase");h.updateState(a,b,e,f);h.isEmpty()&&(g[d]=h,h.trigger("destroy"));return g},updateRemoveElementState:function(a,
b,c,f,d){d=_.clone(d||[]);d.push(f);if("all"===f)return this.updateState(this.session,b,c,d);if(_.isNull(c))return this.updateRemoveAttributeState(f,c);if(_.isObject(c)&&!_.isArray(c))return this.updateRemoveObjectState(a,b,c,d,f);if(_.isString(c)&&TorrentClient.prototype.isRPCFunctionSignature(c))return this.updateRemoveFunctionState(f);if(_.isString(c)&&TorrentClient.prototype.isJSFunctionSignature(c))return this.updateRemoveAttributeState(f,this.client.getStoredFunction(c));if("id"!==f)return this.updateRemoveAttributeState(f,
c)},updateRemoveState:function(a,b,c,f){var d={},g;for(g in c)void 0===b[g]&&_.extend(d,this.updateRemoveElementState(a,b[g],c[g],g,f));return d},updateAddFunctionState:function(a,b,e,f){e=_.clone(e||[]);e.push(f);a=this.client.createFunction(a,e,b);c(!(f in this.bt),"trying to add a function that already exists");this.bt[f]=a;"get"!==f&&("set"!==f&&"unset"!==f&&"length"!==f)&&(c(!(f in this),'trying to add the function "'+f+'", which already exists in the prototype of this object'),this[f]=a,this.trigger("add:"+
f));this.trigger("add:bt:"+f);this.trigger("add:bt",this.bt[f],f);return{}},updateAddObjectState:function(a,b,c,f,d){var a={},g=this.get(d);void 0===g&&(g=BtappCollection.prototype.verifyPath(f)?new BtappCollection:new BtappModel({id:d}),g.path=f,g.client=this.client,a[d]=g);g.updateState(this.session,b,c,f);return a},updateAddElementState:function(a,b,c,f,d){var g=_.clone(d||[]);g.push(f);_.isString(c)&&TorrentClient.prototype.isJSFunctionSignature(c)&&(c=this.client.getStoredFunction(c));return"all"===
f?this.updateState(this.session,b,c,g):_.isNull(b)?this.updateAddAttributeState(a,b,c,g,f):_.isObject(b)&&!_.isArray(b)?this.updateAddObjectState(a,b,c,g,f):_.isString(b)&&TorrentClient.prototype.isRPCFunctionSignature(b)?this.updateAddFunctionState(a,b,d,f):_.isString(b)&&TorrentClient.prototype.isJSFunctionSignature(b)?this.updateAddAttributeState(a,this.client.getStoredFunction(b),c,d,f):this.updateAddAttributeState(a,b,c,g,f)},updateAddState:function(a,b,c,f){var d={},g;for(g in b)_.extend(d,
this.updateAddElementState(a,b[g],c[g],g,f));return d},updateState:function(a,b,e,f){c(!h(b)||!h(e),'the client is outputing empty objects("'+f+'")...these should have been trimmed off');this.session=a;this.path||(this.path=f,c(this.verifyPath(this.path),"cannot updateState with an invalid collection path"));b=b||{};e=e||{};this.applyStateChanges(this.updateAddState(a,b,e,f),this.updateRemoveState(a,b,e,f))},sync:function(){}};this.BtappCollection=Backbone.Collection.extend(d).extend({initialize:function(a,
b){Backbone.Collection.prototype.initialize.apply(this,arguments);d.initialize.apply(this,arguments);this.on("add",this.customAddEvent,this);this.on("remove",this.customRemoveEvent,this);this.on("change",this.customChangeEvent,this)},customEvent:function(a,b){_.isFunction(b)||(c(b&&b.id,"called a custom "+a+" event without a valid attribute"),this.trigger(a+":"+b.id,b))},customAddEvent:function(a){this.customEvent("add",a)},customRemoveEvent:function(a){this.customEvent("remove",a)},customChangeEvent:function(a){this.customEvent("change",
a)},destructor:function(){this.off("add",this.customAddEvent,this);this.off("remove",this.customRemoveEvent,this);this.off("change",this.customChangeEvent,this);this.trigger("destroy")},clearState:function(){this.each(function(a){a.clearState()});this.initializeValues();this.reset();this.destructor()},verifyPath:function(a){return _.any([["btapp","torrent"],["btapp","torrent","all","*","file"],["btapp","torrent","all","*","peer"],["btapp","label"],["btapp","label","all","*","torrent"],"btapp label all * torrent all * file".split(" "),
"btapp label all * torrent all * peer".split(" "),["btapp","rss"],["btapp","rss","all","*","item"],["btapp","stream"],["btapp","stream","all","*","diskio"]],function(b){if(b.length!==a.length)return!1;for(var c=0;c<b.length;c++)if("*"!==b[c]&&b[c]!==a[c])return!1;return!0})},updateRemoveAttributeState:function(){throw"trying to remove an invalid type from a BtappCollection";},updateAddAttributeState:function(){throw"trying to add an invalid type to a BtappCollection";},isEmpty:function(){return h(this.bt)&&
0===this.length},applyStateChanges:function(a,b){this.add(_.values(a));this.remove(_.values(b))}});this.BtappModel=Backbone.Model.extend(d).extend({initialize:function(a){Backbone.Model.prototype.initialize.apply(this,arguments);d.initialize.apply(this,arguments);this.on("change",this.customEvents,this)},destructor:function(){this.off("change",this.customEvents,this);this.trigger("destroy")},clearState:function(){this.initializeValues();var a=_.clone(this.attributes);delete a.id;_.each(a,function(a){a&&
(_.isObject(a)&&a.hasOwnProperty("clearState"))&&a.clearState()});Backbone.Model.prototype.set.call(this,a,{internal:!0,unset:!0});this.destructor()},customEvents:function(){var a=this.changedAttributes();_.each(a,_.bind(function(a,c){if(void 0===a){var f=this.previous(c);this.trigger("remove",f,c);this.trigger("remove:"+c,f)}else void 0===this.previous(c)&&(this.trigger("add",a,c),this.trigger("add:"+c,a))},this))},verifyPath:function(){return!0},updateRemoveAttributeState:function(a,b){var e={};
c(this.get(a)===b,"trying to remove an attribute, but did not provide the correct previous value");e[a]=this.get(a);return e},updateAddAttributeState:function(a,b,e,f,d){a={};c(this.get(d)!==b,"trying to set a variable to the existing value ["+f+" -> "+JSON.stringify(b)+"]");void 0!==e&&c(this.get(d)===e,"trying to update an attribute, but did not provide the correct previous value");a[d]=b;return a},isEmpty:function(){var a=_.keys(this.toJSON());return h(this.bt)&&(0===a.length||1===a.length&&"id"===
a[0])},applyStateChanges:function(a,b){Backbone.Model.prototype.set.call(this,a,{internal:!0});Backbone.Model.prototype.set.call(this,b,{internal:!0,unset:!0})},set:function(a,b,c){var d=function(a,b){if(!(c&&"internal"in c)&&!_.isUndefined(this.get(b)))throw"please use save to set attributes directly to the client";};_.isObject(a)||null===a?_(a).each(d,this):d.call(this,b,a);return Backbone.Model.prototype.set.apply(this,arguments)},save:function(a){var b=[];_(a).each(function(a,c){b.push(this.bt.set(c,
a))},this);return jQuery.when.apply(jQuery,b)}});this.Btapp=BtappModel.extend({initialize:function(){BtappModel.prototype.initialize.apply(this,arguments);this.path=["btapp"];this.connected_state=!1;this.last_query=this.session=this.queries=this.client=null;_.bindAll(this,"connect","disconnect","connected","fetch","onEvents","onFetch","onConnectionError");this.on("add:events",this.setEvents,this)},destructor:function(){},connect:function(a){c(!this.client,"trying to connect to an undefined client");
c(!this.connected_state,"trying to connect when already connected");this.connected_state=!0;c(!this.session,"trying to create another session while one is active");a=a||{};this.poll_frequency=0;this.queries=a.queries||Btapp.QUERIES.ALL;c(_.isArray(this.queries),"the queries attribute must be an array of arrays of strings");c(_.all(this.queries,function(a){return _.isArray(a)&&_.all(a,function(a){return _.isString(a)})}),"the queries attribute must be an array of arrays of strings");a.btapp=this;c(!_.isUndefined(TorrentClient),
"client.btapp.js is a hard dependency");this.setClient(a);var b=new jQuery.Deferred,d=function(){this.off("client:connected",d,this);b.resolve()};this.on("client:connected",d,this);return b},setClient:function(a){"username"in a&&"password"in a||"remote_data"in a?(this.client=new FalconTorrentClient(a),this.client.bind("client:error_connecting",this.disconnect,this)):this.client=new LocalTorrentClient(a);this.client.bind("all",this.trigger,this);this.client.bind("client:connected",this.fetch)},setEvents:function(a){_.each(a.toJSON(),
function(b,c){if("id"!==c){var d={};d[c]=_.bind(this.trigger,this,c);a.save(d)}},this)},disconnect:function(){this.trigger("disconnect","manual");c(this.client,"trying to disconnect from an undefined client");c(this.connected_state,"trying to disconnect when not connected");this.session&&this.client.query({type:"disconnect",session:this.session});this.connected_state=!1;this.last_query&&(this.last_query.abort(),this.last_query=null);this.session=null;this.next_timeout&&clearTimeout(this.next_timeout);
this.client.disconnect();this.queries=this.client=this.client.btapp=null;this.clearState()},connected:function(){return this.connected_state},onConnectionError:function(){this.trigger("disconnect","error");this.poll_frequency=3E3;this.clearState();this.session=null;this.last_query&&(this.last_query.abort(),this.last_query=null);this.client&&_.delay(_.bind(this.client.reset,this.client),500)},onFetch:function(a){c("session"in a,"did not recieve a session id from the client");this.session=a.session;
this.waitForEvents(a.session)},fetch:function(){this.client&&(this.last_query=this.client.query({type:"state",queries:JSON.stringify(this.queries)}).done(this.onFetch).fail(this.onConnectionError))},onEvent:function(a,b){if("add"in b||"remove"in b)b.add=b.add||{},b.remove=b.remove||{},this.updateState(a,b.add.btapp,b.remove.btapp,["btapp"]);else if("callback"in b)this.client.btappCallbacks[b.callback](b.arguments);else throw"received invalid data from the client";},onEvents:function(a,b){c(this.session===
a,"should not receive data for a different session after creating a new one. do not forget to abort the last call of your old session.");if(this.connected_state){this.trigger("sync",b);this.poll_frequency=0===b.length?Math.min(3E3,this.poll_frequency+100):0;for(var d=0;d<b.length;d++)this.onEvent(a,b[d]);this.next_timeout=setTimeout(_.bind(this.waitForEvents,this,a),this.poll_frequency)}},waitForEvents:function(a){this.client&&(this.last_query=this.client.query({type:"update",session:a}).done(_.bind(this.onEvents,
this,a)).fail(this.onConnectionError))}});Btapp.VERSION="0.2.0";Btapp.QUERIES={ALL:[["btapp"]],DHT:[["btapp","dht"]],TORRENTS_BASIC:[["btapp","create"],["btapp","add","torrent"],"btapp torrent all * file all *".split(" "),"btapp torrent all * properties all *".split(" ")],EVENTS:[["btapp","events"]],SETTINGS:[["btapp","settings"]],REMOTE:[["btapp","connect_remote"],["btapp","settings","all","webui.uconnect_enable"]]};Btapp.STATUS={TORRENT:{DELETED:-1,DOWNLOAD_FAILED:0,ADDED:1,COMPLETE:2,METADATA_COMPLETE:3},
RSS_FEED:{DELETED:-1,ADDED:1}};Btapp.REMOVE={NO_DELETE:0,DELETE_TORRENT:1,DELETE_DATA:2,DELETE_BOTH:3,DELETE_TO_TRASH:4,DELETE_CONVERTED_FILES:5};Btapp.TORRENT={PRIORITY:{LOW:0,MEDIUM:1,HIGH:2,METADATA_ONLY:3},FILE:{PRIORITY:{NO_DOWNLOAD:0,LOW:5,MEDIUM:10,HIGH:15}},REMOVE:{NO_DELETE:0,DELETE_TORRENT:1,DELETE_DATA:2,DELETE_TORRENT_AND_DATA:3}}}).call(this);define("btapp",["client.btapp","plugin.btapp","pairing.btapp","backbone","backbrace"],function(c){return function(){return c.Btapp}}(this));
